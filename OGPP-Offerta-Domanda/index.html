<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>OGPP: Domanda & Offerta</title>
    <!-- KaTeX for Math Rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:wght@700&display=swap');

        :root {
            /* --- COLORI & TEMA --- */
            
            /* LIGHT MODE */
            --bg-light: #f5f5f4;
            --text-light: #292524; 
            --text-light-secondary: #57534e; 
            --card-bg-light: #ffffff;
            --card-border-light: #e7e5e4; 
            --accent-light: #0369a1;
            --shadow-light: 0 4px 20px -2px rgba(28, 25, 23, 0.06);
            --focus-ring-light: #0ea5e9;
            --highlight-light: #e0f2fe; 
            
            /* Card Back Colors - Light */
            --flip-front-bg-light: #fafaf9; 
            --flip-back-bg-light: #f0f9ff; 
            --flip-back-text-light: #0c4a6e;

            /* Quiz Explanation Colors - Light */
            --quiz-expl-bg-light: #f0fdf4;
            --quiz-expl-border-light: #bbf7d0;
            --quiz-expl-text-light: #14532d;

            /* Formula Colors - Light */
            --formula-bg-light: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            --formula-border-light: #0ea5e9;
            --formula-text-light: #0c4a6e;

            /* DARK MODE */
            --bg-dark: #0f172a;
            --text-dark: #e2e8f0; 
            --text-dark-secondary: #94a3b8; 
            --card-bg-dark: #1e293b; 
            --card-border-dark: #334155; 
            --accent-dark: #38bdf8; 
            --shadow-dark: 0 10px 15px -3px rgba(0, 0, 0, 0.4);
            --focus-ring-dark: #7dd3fc;
            
            /* Card Back Colors - Dark */
            --flip-front-bg-dark: #020617; 
            --flip-back-bg-dark: #1e293b; 
            --flip-back-text-dark: #e2e8f0;

            /* Quiz Explanation Colors - Dark */
            --quiz-expl-bg-dark: #064e3b;
            --quiz-expl-border-dark: #059669;
            --quiz-expl-text-dark: #ecfdf5;

            /* Formula Colors - Dark */
            --formula-bg-dark: linear-gradient(135deg, #1e3a5f 0%, #0f172a 100%);
            --formula-border-dark: #38bdf8;
            --formula-text-dark: #e0f2fe;
        }

        [data-theme="light"] {
            --bg-color: var(--bg-light); --text-color: var(--text-light); --text-secondary-color: var(--text-light-secondary); 
            --card-bg-color: var(--card-bg-light); --accent-color: var(--accent-light);
            --border-color: var(--card-border-light); --shadow-color: var(--shadow-light); 
            --focus-ring-color: var(--focus-ring-light); --highlight-color: var(--highlight-light);
            --highlight-text-color: var(--text-light);
            --flip-front-bg: var(--flip-front-bg-light);
            --flip-back-bg: var(--flip-back-bg-light);
            --flip-back-text: var(--flip-back-text-light);
            --quiz-expl-bg: var(--quiz-expl-bg-light);
            --quiz-expl-border: var(--quiz-expl-border-light);
            --quiz-expl-text: var(--quiz-expl-text-light);
            --formula-bg: var(--formula-bg-light);
            --formula-border: var(--formula-border-light);
            --formula-text: var(--formula-text-light);
        }
        [data-theme="dark"] {
            --bg-color: var(--bg-dark); --text-color: var(--text-dark); --text-secondary-color: var(--text-dark-secondary);
            --card-bg-color: var(--card-bg-dark); --accent-color: var(--accent-dark);
            --border-color: var(--card-border-dark); --shadow-color: var(--shadow-dark); 
            --focus-ring-color: var(--focus-ring-dark); --highlight-color: var(--highlight-dark);
            --highlight-text-color: var(--highlight-text-dark);
            --flip-front-bg: var(--flip-front-bg-dark);
            --flip-back-bg: var(--flip-back-bg-dark);
            --flip-back-text: var(--flip-back-text-dark);
            --quiz-expl-bg: var(--quiz-expl-bg-dark);
            --quiz-expl-border: var(--quiz-expl-border-dark);
            --quiz-expl-text: var(--quiz-expl-text-dark);
            --formula-bg: var(--formula-bg-dark);
            --formula-border: var(--formula-border-dark);
            --formula-text: var(--formula-text-dark);
        }
        
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        
        html { font-size: 100%; -webkit-text-size-adjust: 100%; scroll-behavior: smooth; }
        
        body {
            font-family: 'Inter', sans-serif; background-color: var(--bg-color); color: var(--text-color);
            transition: background-color 0.4s ease, color 0.4s ease; -webkit-tap-highlight-color: transparent;
            line-height: 1.8; overflow-x: hidden;
        }
        body.no-scroll { overflow: hidden; height: 100%; width: 100%; }

        button { cursor: pointer; border: none; background: none; font-family: inherit; color: inherit; -webkit-tap-highlight-color: transparent; }
        button:focus-visible { outline: 2px solid var(--focus-ring-color); outline-offset: 2px; border-radius: 4px; }
        button:active { transform: scale(0.98); }

        .app-container { opacity: 0; transition: opacity 0.5s ease; }
        .app-container.loaded { opacity: 1; }
        
        /* HEADER */
        .header {
            position: sticky; top: 0; z-index: 100;
            background-color: rgba(245, 245, 244, 0.9);
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid transparent;
            transition: transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1), box-shadow 0.3s ease;
            will-change: transform;
        }
        [data-theme="dark"] .header { background-color: rgba(15, 23, 42, 0.9); }
        .header.hidden { transform: translateY(-100%); }
        .header.scrolled { border-bottom-color: var(--border-color); box-shadow: var(--shadow-color); }

        .header-content { padding: 0.75rem 1.5rem; display: flex; justify-content: space-between; align-items: center; min-height: 64px; }
        .header-title { font-family: 'Playfair Display', serif; font-size: 1.25rem; font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex-grow: 1; text-align: left; margin-right: 1rem; }
        
        .controls { display: flex; align-items: center; gap: 0.75rem; }
        
        .icon-btn { display: flex; align-items: center; justify-content: center; width: 42px; height: 42px; border-radius: 12px; transition: background-color 0.2s; }
        .icon-btn:hover { background-color: var(--border-color); }
        .icon-btn svg { width: 22px; height: 22px; color: var(--text-secondary-color); transition: color 0.3s; }
        .icon-btn.active svg { color: var(--accent-color); }
        
        /* Nav Buttons Desktop */
        .nav-buttons-desktop {
            display: none;
            position: fixed; bottom: 2rem; right: 2rem;
            flex-direction: column; gap: 0.5rem;
            z-index: 95;
        }
        .icon-btn.disabled { opacity: 0.3; pointer-events: none; cursor: default; }

        #autoscroll-btn { display: none; }

        .theme-switcher .sun-icon { display: none; } [data-theme="light"] .theme-switcher .sun-icon { display: block; }
        .theme-switcher .moon-icon { display: none; } [data-theme="dark"] .theme-switcher .moon-icon { display: block; }

        .mode-switcher { display: flex; background-color: var(--border-color); border-radius: 14px; padding: 4px; }
        .mode-btn { font-size: 0.85rem; font-weight: 600; padding: 6px 16px; border-radius: 10px; color: var(--text-secondary-color); transition: all 0.2s ease; }
        .mode-btn.active { background-color: var(--card-bg-color); color: var(--text-color); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .desktop-mode-switcher { display: none; }

        /* TIMELINE MOBILE */
        .progress-timeline-mobile { padding: 0 1.5rem 1rem 1.5rem; touch-action: none; }
        .timeline-track { position: relative; width: 100%; height: 6px; background-color: var(--border-color); border-radius: 3px; cursor: pointer; }
        .timeline-progress { position: absolute; top: 0; left: 0; height: 100%; background-color: var(--accent-color); border-radius: 3px; width: 0; transition: width 0.2s linear; will-change: width; }
        .timeline-nodes { position: absolute; top: 50%; left: 0; width: 100%; display: flex; justify-content: space-between; pointer-events: none; }
        .timeline-node-point {
            width: 12px; height: 12px; border-radius: 50%; background-color: var(--border-color);
            border: 2px solid var(--bg-color); transform: translateY(-50%); transition: transform 0.3s ease, background-color 0.3s ease;
            pointer-events: auto;
        }
        .timeline-node-point.past, .timeline-node-point.active { background-color: var(--accent-color); }
        .timeline-node-point.active { transform: translateY(-50%) scale(1.4); box-shadow: 0 0 0 4px var(--highlight-color); }

        /* LAYOUT & CHAPTERS */
        .main-layout { padding-top: 4rem; }
        #story-panel { padding: 0 1.5rem; }
        
        .story-chapter {
            min-height: 90vh; padding: 6rem 0;
            display: flex; align-items: center; justify-content: center;
            opacity: 0.5; transform: scale(0.98); filter: blur(1px);
            transition: opacity 0.6s ease, transform 0.6s ease, filter 0.6s ease; 
            border-bottom: 1px dashed var(--border-color);
        }
        .story-chapter:last-child { border-bottom: none; min-height: 80vh; }
        .story-chapter.active { opacity: 1; transform: scale(1); filter: blur(0); }
        
        .chapter-content { max-width: 680px; width: 100%; }
        .chapter-title { font-family: 'Playfair Display', serif; font-size: clamp(2rem, 8vw, 3rem); color: var(--text-color); margin-bottom: 2rem; line-height: 1.15; letter-spacing: -0.02em; word-wrap: break-word;}
        .chapter-body { font-size: 1.125rem; line-height: 2.1; color: var(--text-secondary-color); }
        
        .chapter-body p, .chapter-body ul, .chapter-body ol { margin-bottom: 1.5rem; }
        .chapter-body ul, .chapter-body ol { padding-left: 1.2rem; }
        .chapter-body li { margin-bottom: 0.75rem; padding-left: 0.5rem; }
        .chapter-body li::marker { color: var(--accent-color); font-weight: 700; }
        .chapter-body strong { font-weight: 700; color: var(--text-color); }
        
        .chapter-body h3 {
             font-family: 'Playfair Display', serif; font-size: 1.8rem; margin: 3rem 0 1.5rem 0; color: var(--text-color); line-height: 1.3;
        }

        .chapter-body h4 { 
            font-size: 0.95rem; margin: 2.5rem 0 1rem 0; color: var(--accent-color); 
            text-transform: uppercase; letter-spacing: 0.08em; font-weight: 700;
            display: flex; align-items: center; gap: 0.5rem;
            line-height: 1.4;
        }
        .chapter-body h4::after { content: ''; flex-grow: 1; height: 1px; background-color: var(--border-color); opacity: 0.5; }
        
        /* ====================================== */
        /* ENHANCED MATH STYLING - MOBILE FIRST  */
        /* ====================================== */
        
        /* Global KaTeX Improvements */
        .katex {
            font-size: 1.1em !important;
            line-height: 1.5 !important;
        }
        
        .katex-display {
            margin: 1rem 0 !important;
            overflow-x: auto;
            overflow-y: hidden;
            -webkit-overflow-scrolling: touch;
            padding: 0.5rem 0;
        }
        
        .katex-display > .katex {
            white-space: nowrap;
        }
        
        /* ENHANCED FORMULA BOX */
        .formula-box {
            position: relative;
            background: var(--formula-bg);
            border: 2px solid var(--formula-border);
            border-radius: 16px;
            padding: 1.25rem;
            margin: 2rem 0;
            text-align: center;
            box-shadow: var(--shadow-color), 0 0 40px -10px rgba(14, 165, 233, 0.15);
            overflow: hidden;
        }
        .formula-box::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--accent-color), #06b6d4, var(--accent-color));
            background-size: 200% 100%;
            animation: shimmer 3s ease-in-out infinite;
        }
        @keyframes shimmer {
            0%, 100% { background-position: 0% 0; }
            50% { background-position: 100% 0; }
        }
        .formula-box .formula-label {
            display: inline-block;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--accent-color);
            background: var(--card-bg-color);
            padding: 0.2rem 0.6rem;
            border-radius: 20px;
            margin-bottom: 0.75rem;
            border: 1px solid var(--border-color);
        }
        
        /* Formula main container - scrollable on mobile */
        .formula-box .formula-main {
            overflow-x: auto;
            overflow-y: hidden;
            -webkit-overflow-scrolling: touch;
            padding: 0.75rem 0;
            margin: 0 -0.5rem;
            scrollbar-width: thin;
            scrollbar-color: var(--accent-color) transparent;
        }
        
        .formula-box .formula-main::-webkit-scrollbar {
            height: 4px;
        }
        .formula-box .formula-main::-webkit-scrollbar-track {
            background: transparent;
        }
        .formula-box .formula-main::-webkit-scrollbar-thumb {
            background: var(--accent-color);
            border-radius: 4px;
            opacity: 0.5;
        }
        
        .formula-box .formula-main .katex { 
            font-size: clamp(1.1rem, 4.5vw, 1.6rem) !important; 
            color: var(--formula-text);
        }
        
        .formula-box .formula-description {
            margin-top: 1rem;
            font-size: 0.8rem;
            color: var(--text-secondary-color);
            font-style: italic;
            line-height: 1.4;
        }
        
        /* Scroll hint for formulas on mobile */
        .formula-box .scroll-hint {
            display: none;
            font-size: 0.7rem;
            color: var(--accent-color);
            margin-top: 0.5rem;
            opacity: 0.7;
        }
        
        .formula-box.scrollable .scroll-hint {
            display: block;
        }

        /* MATH CALCULATION STEPS - Mobile Optimized */
        .math-steps {
            background: var(--card-bg-color);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1rem;
            margin: 1.5rem 0;
        }
        .math-step {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            padding: 0.75rem 0;
            border-bottom: 1px dashed var(--border-color);
        }
        .math-step:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }
        .math-step:first-child {
            padding-top: 0;
        }
        .step-number {
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 24px;
            width: 24px;
            height: 24px;
            background: var(--accent-color);
            color: white;
            border-radius: 50%;
            font-size: 0.7rem;
            font-weight: 700;
            flex-shrink: 0;
            margin-top: 2px;
        }
        .step-content {
            flex: 1;
            min-width: 0;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            padding: 10px 0 10px 0;
        }
        .step-content .katex {
            font-size: clamp(0.9rem, 3.5vw, 1.1rem) !important;
        }
        .step-content .katex-display {
            margin: 0.25rem 0 !important;
            text-align: left;
        }
        .step-label {
            font-size: 0.75rem;
            color: var(--text-secondary-color);
            margin-bottom: 0.25rem;
            font-weight: 500;
        }

        /* MATH RESULT HIGHLIGHT */
        .math-result {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
            padding: 0.75rem 1rem;
            border-radius: 12px;
            margin: 1.25rem 0;
            border: 2px solid #22c55e;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        [data-theme="dark"] .math-result {
            background: linear-gradient(135deg, #14532d 0%, #166534 100%);
            border-color: #22c55e;
        }
        .math-result .katex {
            font-size: clamp(0.95rem, 3.5vw, 1.2rem) !important;
            color: #14532d;
        }
        [data-theme="dark"] .math-result .katex {
            color: #dcfce7;
        }
        .math-result-icon {
            font-size: 1.1rem;
            flex-shrink: 0;
        }
        .math-result-content {
            display: flex;
            align-items: center;
            gap: 0.35rem;
            flex-wrap: wrap;
        }

        /* INLINE MATH STYLING - Better Mobile Visibility */
        .inline-math {
            display: inline-block;
            background: rgba(14, 165, 233, 0.12);
            padding: 0.15rem 0.5rem;
            border-radius: 6px;
            margin: 0 0.15rem;
            border: 1px solid rgba(14, 165, 233, 0.2);
        }
        .inline-math .katex {
            font-size: 0.95em !important;
        }
        [data-theme="dark"] .inline-math {
            background: rgba(56, 189, 248, 0.18);
            border-color: rgba(56, 189, 248, 0.3);
        }

        /* VARIABLE DEFINITION - Mobile Grid */
        .var-definition {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            background: var(--card-bg-color);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1rem;
            margin: 1.25rem 0;
        }
        .var-row {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            padding: 0.5rem 0;
            border-bottom: 1px dashed var(--border-color);
        }
        .var-row:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }
        .var-row:first-child {
            padding-top: 0;
        }
        .var-symbol {
            font-weight: 600;
            color: var(--accent-color);
            flex-shrink: 0;
            min-width: 80px;
            overflow-x: auto;
        }
        .var-symbol .katex {
            font-size: 0.9rem !important;
        }
        .var-meaning {
            color: var(--text-secondary-color);
            font-size: 0.9rem;
            line-height: 1.4;
        }

        /* INTERACTIVE ELEMENTS */
        .interactive-accordion { 
            margin: 2rem 0; border: 1px solid var(--border-color); border-radius: 16px; 
            overflow: hidden; background-color: var(--card-bg-color); box-shadow: var(--shadow-color);
            width: 100%;
        }
        .acc-item { border-bottom: 1px solid var(--border-color); }
        .acc-item:last-child { border-bottom: none; }
        .acc-header {
            width: 100%; padding: 1.25rem 1.5rem; text-align: left;
            background-color: var(--card-bg-color); font-weight: 600; color: var(--text-color);
            display: flex; justify-content: space-between; align-items: center;
            transition: background-color 0.2s; font-size: 1rem; line-height: 1.4;
        }
        .acc-header:hover { background-color: var(--bg-color); }
        .acc-header .acc-icon { 
            width: 24px; height: 24px; display: flex; align-items: center; justify-content: center;
            color: var(--accent-color); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            flex-shrink: 0; margin-left: 12px;
        }
        .acc-item.open .acc-header .acc-icon { transform: rotate(135deg); }
        .acc-body {
            max-height: 0; overflow: hidden; transition: max-height 0.35s cubic-bezier(0.4, 0, 0.2, 1);
            background-color: var(--bg-color);
        }
        .acc-content { padding: 1.25rem 1.5rem; font-size: 1rem; color: var(--text-secondary-color); border-top: 1px dashed var(--border-color); line-height: 1.6; }

        /* FLIP CARDS - Math Optimized */
        .flip-container { 
            margin: 2.5rem auto; 
            perspective: 1000px; 
            width: 100%; 
            max-width: 500px; 
            min-height: 420px; 
        }
        .flip-card-inner {
            position: relative; width: 100%; height: 100%;
            transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            transform-style: preserve-3d; cursor: pointer;
            box-shadow: var(--shadow-color); border-radius: 20px;
            display: grid; grid-template-areas: "card-face";
        }
        .flip-container.flipped .flip-card-inner { transform: rotateY(180deg); }
        
        .flip-front, .flip-back {
            grid-area: card-face; width: 100%;
            -webkit-backface-visibility: hidden; backface-visibility: hidden;
            border-radius: 20px; display: flex; flex-direction: column;
            align-items: center; justify-content: center; padding: 1.5rem;
        }
        
        .flip-front { background-color: var(--flip-front-bg); border: 1px solid var(--border-color); }
        .flip-back { background-color: var(--flip-back-bg); color: var(--flip-back-text); transform: rotateY(180deg); }
        
        .flip-title { font-size: 1.25rem; font-weight: 700; margin-bottom: 0.75rem; color: var(--text-color); line-height: 1.3; text-align: center; }
        .flip-hint { 
            font-size: 0.8rem; color: var(--accent-color); margin-top: 1.5rem; 
            font-weight: 600; text-transform: uppercase; letter-spacing: 1.5px;
            opacity: 0.8; display: flex; align-items: center; gap: 6px; flex-shrink: 0;
        }
        .flip-hint::after { content: '↻'; font-size: 1.2em; margin-top: -2.6px; }
        
        .flip-back p { color: var(--flip-back-text); font-size: 1.1rem; line-height: 1.6; margin: 0; font-weight: 500; text-align: center;}
        .flip-back ul { 
            text-align: left; 
            padding-left: 0; 
            list-style: none;
            width: 100%;
        }
        .flip-back li {
            padding: 0.6rem 0;
            border-bottom: 1px dashed rgba(255,255,255,0.2);
            font-size: 0.85rem;
            line-height: 1.5;
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }
        .flip-back li:last-child {
            border-bottom: none;
        }
        .flip-back .katex {
            font-size: 0.85rem !important;
        }
        .flip-back .elasticity-type {
            font-weight: 700;
            color: var(--accent-color);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .flip-back .elasticity-desc {
            font-weight: 400;
            opacity: 0.9;
            padding-left: 0;
        }

        #timeline-desktop { display: none; }
        #scroll-sentinel { position: absolute; top: 0; height: 1px; width: 1px; pointer-events: none; }

        .app-footer {
            position: fixed; bottom: 0; left: 0; width: 100%; z-index: 90;
            display: flex; justify-content: center; 
            padding: 1rem 1.5rem calc(1rem + env(safe-area-inset-bottom));
            pointer-events: none;
        }
        .app-footer.hidden { transform: translateY(150%); }
        .footer-mode-switcher { 
            display: flex; pointer-events: auto;
            background-color: rgba(255, 255, 255, 0.9); 
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); 
            border-radius: 24px; padding: 6px; 
            box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1);
            border: 1px solid rgba(0,0,0,0.05);
        }
        [data-theme="dark"] .footer-mode-switcher { background-color: rgba(28, 25, 23, 0.9); border-color: rgba(255,255,255,0.1); }

        /* QUIZ MODE */
        .quiz-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 200;
            display: flex; align-items: center; justify-content: center; padding: 1rem;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
            opacity: 0; transition: opacity 0.4s ease, visibility 0.4s; visibility: hidden;
        }
        .quiz-overlay.visible { opacity: 1; visibility: visible; }
        .quiz-container {
            background-color: var(--card-bg-color); border: 1px solid var(--border-color);
            width: 96%; max-width: 600px; 
            height: auto; max-height: 85vh;
            border-radius: 24px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            display: flex; flex-direction: column; overflow: hidden;
            transform: scale(0.95) translateY(10px); transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .quiz-overlay.visible .quiz-container { transform: scale(1) translateY(0); }
        
        .quiz-header { padding: 1rem 1.5rem; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; background-color: var(--bg-color); }
        .quiz-title { font-weight: 600; color: var(--text-secondary-color); font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.05em; }
        .quiz-body { flex-grow: 1; overflow-y: auto; display: flex; flex-direction: column; -webkit-overflow-scrolling: touch; }
        #quiz-content-wrapper { padding: 1.5rem; display: flex; flex-direction: column; justify-content: center; min-height: 100%;}
        
        .quiz-slide { width: 100%; opacity: 0; transition: opacity 0.3s ease; }
        .quiz-slide.active { opacity: 1; }
        
        .quiz-question-text { 
            font-size: clamp(1rem, 4vw, 1.35rem); 
            font-weight: 700; 
            margin-bottom: 1.5rem; 
            line-height: 1.5; 
            color: var(--text-color); 
        }
        .quiz-question-text .katex {
            font-size: 1em !important;
        }
        .quiz-answers { display: grid; gap: 0.75rem; }
        .quiz-answer-btn {
            width: 100%; padding: 1rem 1.25rem; text-align: left; background-color: var(--bg-color);
            border: 2px solid transparent; border-radius: 16px; font-size: 0.95rem; font-weight: 500;
            transition: all 0.2s ease; color: var(--text-color);
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            word-break: break-word; hyphens: auto; line-height: 1.4;
        }
        .quiz-answer-btn .katex {
            font-size: 0.9em !important;
        }
        .quiz-answer-btn:hover { background-color: var(--border-color); }
        .quiz-answer-btn:active { transform: scale(0.98); }
        .quiz-answer-btn.correct { background-color: #dcfce7; color: #14532d; border-color: #22c55e; }
        [data-theme="dark"] .quiz-answer-btn.correct { background-color: #14532d; color: #f0fdf4; border-color: #22c55e; }
        .quiz-answer-btn.incorrect { background-color: #fee2e2; color: #7f1d1d; border-color: #ef4444; }
        [data-theme="dark"] .quiz-answer-btn.incorrect { background-color: #7f1d1d; color: #fef2f2; border-color: #ef4444; }
        .quiz-answer-btn.disabled { opacity: 0.6; pointer-events: none; }
        
        .quiz-explanation {
            margin-top: 1.5rem; padding: 1.25rem; border-radius: 12px; font-size: 0.95rem; line-height: 1.5;
            background-color: var(--quiz-expl-bg); border: 1px solid var(--quiz-expl-border); color: var(--quiz-expl-text);
            opacity: 0; transform: translateY(10px); transition: opacity 0.4s ease, transform 0.4s ease; display: none;
        }
        .quiz-explanation.visible { opacity: 1; transform: translateY(0); display: block; }
        .quiz-explanation .katex {
            font-size: 0.95em !important;
        }

        .quiz-footer { 
            padding: 1.5rem; border-top: 1px solid var(--border-color); flex-shrink: 0; background-color: var(--bg-color);
            padding-bottom: calc(1.5rem + env(safe-area-inset-bottom)/2);
        }
        .quiz-next-btn { width: 100%; background-color: var(--accent-color); color: white; padding: 1rem; border-radius: 14px; font-size: 1.1rem; font-weight: 600; transition: opacity 0.2s, transform 0.2s; }
        .quiz-next-btn:active { transform: scale(0.98); }
        .quiz-next-btn:disabled { background-color: var(--border-color); color: var(--text-secondary-color); cursor: not-allowed; transform: none; }

        .quiz-results-wrapper { text-align: center; display: flex; flex-direction: column; justify-content: center; min-height: 100%; padding: 1.5rem; }
        .quiz-results-title { font-family: 'Playfair Display', serif; font-size: 2.2rem; margin-bottom: 0.5rem; color: var(--text-color); }
        .quiz-results-score { font-size: 3.5rem; font-weight: 800; color: var(--accent-color); line-height: 1; margin: 1rem 0; }
        .quiz-results-text { font-size: 1.1rem; color: var(--text-secondary-color); margin-bottom: 2rem; }
        .quiz-results-actions { display: flex; flex-direction: column; gap: 0.75rem; width: 100%; }
        .quiz-results-actions .quiz-next-btn.secondary { background-color: transparent; border: 2px solid var(--border-color); color: var(--text-color); }
        .quiz-results-actions .quiz-next-btn.secondary:hover { border-color: var(--text-secondary-color); }

        /* ====================================== */
        /* DESKTOP OVERRIDES                     */
        /* ====================================== */
        @media (min-width: 960px) {
            .progress-timeline-mobile { display: none; }
            .app-footer { display: none; }
            .desktop-mode-switcher { display: flex; }
            #autoscroll-btn { display: flex; } 
            
            .nav-buttons-desktop { display: flex; }
            
            .main-layout { 
                display: grid; 
                grid-template-columns: 1fr minmax(0, 680px) 1fr; 
                gap: 2rem; 
                max-width: 100%; 
                margin: 0; 
                padding: 0 2rem; 
            }
            
            #timeline-desktop {
                grid-column: 1;
                display: flex; 
                position: sticky; top: 0; height: 100vh;
                align-items: center; 
                justify-content: flex-end;
            }
            
            #story-panel { grid-column: 2; padding: 0; }

            .timeline-desktop-container { 
                position: relative; 
                width: 220px; 
                padding: 4rem 1rem 4rem 0; 
                display: flex; justify-content: flex-end;
            }
            
            .timeline-svg {
                position: absolute; right: 0; 
                top: 0; height: 100%; width: 2px; overflow: visible;
                z-index: 0;
                pointer-events: none; 
            }
            .timeline-svg-line { stroke: var(--border-color); stroke-width: 2px; fill: none; }
            .timeline-svg-progress {
                stroke: var(--accent-color); stroke-width: 2px; fill: none; transition: stroke-dashoffset 0.4s ease;
            }

            .timeline-desktop-nodes { 
                display: flex; flex-direction: column; gap: 1.5rem; 
                align-items: flex-end; text-align: right; width: 100%; 
                z-index: 1; 
            }
            
            .timeline-desktop-node {
                display: flex; align-items: center; gap: 1.5rem; padding: 0.5rem 0;
                position: relative; transition: opacity 0.3s; flex-direction: row-reverse; 
                width: 140%; 
                cursor: pointer; padding-right: 15px;
            }
            .timeline-desktop-node:hover .node-label { color: var(--accent-color); }
            .timeline-desktop-node .node-point {
                width: 14px; height: 14px; border-radius: 50%; background-color: var(--border-color);
                border: 3px solid var(--bg-color); transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); flex-shrink: 0; 
                z-index: 2; position: relative;
            }
            .timeline-desktop-node::after {
                content: ''; position: absolute; top: 0; right: -10px; bottom: 0; width: 100%; z-index: -1;
            }

            .timeline-desktop-node .node-label { 
                font-size: 0.95rem; font-weight: 500; color: var(--text-secondary-color); 
                transition: color 0.3s ease, transform 0.3s ease;
                white-space: nowrap; 
            }

            .timeline-desktop-node.active .node-point { background-color: var(--accent-color); transform: scale(1.3); box-shadow: 0 0 0 4px var(--highlight-color); }
            .timeline-desktop-node.active .node-label { color: var(--text-color); font-weight: 700; transform: translateX(-5px); }
            .timeline-desktop-node.past .node-point { background-color: var(--accent-color); border-color: var(--accent-color); }

            .story-chapter { padding: 6rem 0; min-height: 85vh; }
            .story-chapter:first-child { padding-top: 4rem; }

            /* Desktop Math Sizing */
            .formula-box {
                padding: 2rem;
                margin: 2.5rem 0;
            }
            
            .formula-box .formula-label {
                font-size: 0.75rem;
                padding: 0.25rem 0.75rem;
                margin-bottom: 1rem;
            }
            
            .formula-box .formula-main .katex { 
                font-size: 1.8rem !important; 
            }
            
            .formula-box .formula-description {
                font-size: 0.9rem;
                margin-top: 1.25rem;
            }
            
            .math-steps {
                padding: 1.5rem;
            }
            
            .math-step {
                gap: 1rem;
            }
            
            .step-number {
                min-width: 28px;
                width: 28px;
                height: 28px;
                font-size: 0.8rem;
            }
            
            .step-content .katex {
                font-size: 1.1rem !important;
            }
            
            .var-definition {
                display: grid;
                grid-template-columns: auto 1fr;
                gap: 0.5rem 1.5rem;
                padding: 1.25rem;
            }
            
            .var-row {
                display: contents;
            }
            
            .var-symbol, .var-meaning {
                padding: 0.5rem 0;
                border-bottom: 1px dashed var(--border-color);
            }
            
            .var-row:last-child .var-symbol,
            .var-row:last-child .var-meaning {
                border-bottom: none;
            }
            
            .flip-container {
                min-height: 380px;
            }
            
            .flip-front, .flip-back {
                padding: 2rem;
            }
            
            .flip-back li {
                flex-direction: row;
                gap: 0.75rem;
                font-size: 0.95rem;
            }
            
            .flip-back .katex {
                font-size: 1rem !important;
            }
        }
        
        @media (min-width: 1200px) {
             .main-layout { gap: 4rem; }
        }
        
        /* Extra small screens */
        @media (max-width: 360px) {
            .formula-box {
                padding: 1rem;
                border-radius: 12px;
            }
            
            .formula-box .formula-main .katex {
                font-size: 1rem !important;
            }
            
            .step-content .katex {
                font-size: 0.85rem !important;
            }
            
            .math-result .katex {
                font-size: 0.9rem !important;
            }
            
            .flip-container {
                min-height: 480px;
            }
            
            .flip-back li {
                font-size: 0.8rem;
            }
            
            .flip-back .katex {
                font-size: 0.8rem !important;
            }
        }
    </style>
</head>
<body>
    <div id="scroll-sentinel"></div>
    <div class="app-container" id="app">
        <header class="header" id="header">
            <div class="header-content">
                <h1 class="header-title" id="header-title">Microeconomia</h1>
                <div class="controls">
                    <div class="mode-switcher desktop-mode-switcher">
                        <button class="mode-btn" data-mode="study">Studio</button>
                        <button class="mode-btn" data-mode="story">Storia</button>
                    </div>
                    
                    <button class="icon-btn" id="autoscroll-btn" aria-label="Attiva/Disattiva Autoscroll">
                         <svg class="w-6 h-6 text-gray-800 dark:text-white" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24">
                          <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 20V7m0 13-4-4m4 4 4-4m4-12v13m0-13 4 4m-4-4-4 4"/>
                        </svg>
                    </button>

                     <button class="icon-btn" id="quiz-btn" aria-label="Avvia Quiz">
                        <svg viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 3L1 9l11 6 9-4.5V12h2V9l-11-6zM5 13.18v4L12 21l7-3.82v-4L12 17l-7-3.82z"/></svg>
                    </button>
                    <button class="icon-btn theme-switcher" aria-label="Cambia Tema">
                        <svg class="sun-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
                        <svg class="moon-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
                    </button>
                </div>
            </div>
            <div class="progress-timeline-mobile">
                <div class="timeline-track" id="timeline-track-mobile">
                    <div class="timeline-progress" id="timeline-progress-mobile"></div>
                    <div class="timeline-nodes" id="timeline-nodes-mobile"></div>
                </div>
            </div>
        </header>
        
        <div class="nav-buttons-desktop">
            <button class="icon-btn" id="prev-chapter-btn" aria-label="Capitolo precedente">
                <svg class="w-6 h-6 text-gray-800" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 24 24"><path fill-rule="evenodd" d="M5.575 13.729C4.501 15.033 5.43 17 7.12 17h9.762c1.69 0 2.618-1.967 1.544-3.271l-4.881-5.927a2 2 0 0 0-3.088 0l-4.88 5.927Z" clip-rule="evenodd"/></svg>
            </button>
            <button class="icon-btn" id="next-chapter-btn" aria-label="Capitolo successivo">
                <svg class="w-6 h-6 text-gray-800" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 24 24"><path fill-rule="evenodd" d="M18.425 10.271C19.499 8.967 18.57 7 16.88 7H7.12c-1.69 0-2.618 1.967-1.544 3.271l4.881 5.927a2 2 0 0 0 3.088 0l4.88-5.927Z" clip-rule="evenodd"/></svg>
            </button>
        </div>

        <div class="main-layout">
            <aside id="timeline-desktop">
                <div class="timeline-desktop-container">
                    <svg class="timeline-svg">
                        <line class="timeline-svg-line" x1="1" y1="0" x2="1" y2="100%"></line>
                        <line class="timeline-svg-progress" id="timeline-progress-desktop" x1="1" y1="0" x2="1" y2="100%"></line>
                    </svg>
                    <div class="timeline-desktop-nodes" id="timeline-nodes-desktop"></div>
                </div>
            </aside>
            <main id="story-panel"></main>
        </div>

        <footer class="app-footer" id="app-footer">
            <div class="mode-switcher footer-mode-switcher">
                <button class="mode-btn" data-mode="study">Studio</button>
                <button class="mode-btn" data-mode="story">Storia</button>
            </div>
        </footer>
    </div>
    
    <div class="quiz-overlay" id="quiz-overlay">
        <div class="quiz-container" id="quiz-container"></div>
    </div>

    <script>
        /* 
           =================================================================
           CONTENUTO DIDATTICO (CON FORMULE LATEX)
           =================================================================
        */
        const learningContent = {
            title: "Domanda e Offerta",
            chapters: [
                {
                    id: 'capitolo-1',
                    title: 'La Domanda di Mercato',
                    description: `
                        <p>La <strong>Domanda</strong> corrisponde alla quantità di beni o servizi che il consumatore è disposto ad acquistare in un certo mercato, in un certo momento e ad un determinato prezzo.</p>
                        
                        <h4>La Legge della Domanda</h4>
                        <p>Esiste una <strong>relazione inversa</strong> tra prezzo e quantità domandata. La legge afferma che: all'aumentare del prezzo di un bene, la quantità domandata decresce (e viceversa). Se il prezzo scende, la domanda sale.</p>

                        <div class="formula-box">
                            <span class="formula-label">Legge della Domanda</span>
                            <div class="formula-main">$$P \\uparrow \\;\\Rightarrow\\; Q_d \\downarrow \\quad \\text{e} \\quad P \\downarrow \\;\\Rightarrow\\; Q_d \\uparrow$$</div>
                            <div class="formula-description">All'aumentare del prezzo, la quantità domandata diminuisce</div>
                        </div>

                        <div class="interactive-accordion">
                            <div class="acc-item">
                                <button class="acc-header">Fattori che influenzano la domanda <span class="acc-icon">+</span></button>
                                <div class="acc-body"><div class="acc-content">
                                    <ul>
                                        <li><strong>Prezzo del bene:</strong> Il fattore principale (movimento lungo la curva).</li>
                                        <li><strong>Reddito:</strong> Se aumenta il reddito, generalmente aumenta la domanda (tranne per i beni inferiori).</li>
                                        <li><strong>Gusti personali:</strong> Preferenze soggettive.</li>
                                        <li><strong>Pubblicità:</strong> Influenza i bisogni indotti.</li>
                                        <li><strong>Prezzo di altri beni:</strong>
                                            <ul>
                                                <li><em>Beni Complementari:</em> Beni usati insieme (es. Auto e Benzina, Caffè e Zucchero). Se sale il prezzo dell'auto, scende la domanda di benzina.</li>
                                                <li><em>Beni Succedanei (Sostituti):</em> Beni che possono sostituirsi l'uno all'altro (es. Burro e Margarina). Se sale il prezzo del burro, sale la domanda di margarina.</li>
                                            </ul>
                                        </li>
                                    </ul>
                                </div></div>
                            </div>
                            <div class="acc-item">
                                <button class="acc-header">Eccezioni alla regola (Beni Inferiori) <span class="acc-icon">+</span></button>
                                <div class="acc-body"><div class="acc-content">
                                    <p>Per i <strong>Beni Inferiori</strong> (beni di scarsa qualità, es. fagioli in scatola o margarina), un aumento del reddito può comportare una <strong>riduzione</strong> della domanda, perché il consumatore ora può permettersi beni di qualità superiore (es. carne o pesce).</p>
                                    <p>Invece, per i <strong>Beni Completamente Soddisfatti</strong> (es. il sale), la domanda rimane stabile anche se il reddito aumenta (non userai più sale solo perché sei più ricco).</p>
                                </div></div>
                            </div>
                        </div>
                    `,
                    storyDescription: `
                        <p>Immagina di entrare in un supermercato. Sei il protagonista di questa storia: <strong>Il Consumatore</strong>.</p>
                        <p>Hai un budget limitato (il tuo <em>Reddito</em>). Ti dirigi verso il reparto frutta. Vedi che le mele costano 1€ al kg. Ne metti 3 kg nel carrello. La settimana dopo, torni e scopri che il prezzo è salito a 2€ al kg. Cosa fai? Probabilmente ne comprerai meno, o forse nessuna, virando sulle pere (un <em>Bene Succedaneo</em>).</p>
                        <p>Questa reazione istintiva è ciò che gli economisti chiamano <strong>Legge della Domanda</strong>: quando il prezzo sale, il tuo carrello si svuota di quel prodotto.</p>
                        <p>Ma non è solo il prezzo a guidarti. Se il tuo capo ti dà un aumento di stipendio, potresti smettere di comprare la margarina (un <em>Bene Inferiore</em>) e iniziare a comprare burro artigianale. La tua domanda cambia non per il prezzo, ma per il tuo potere d'acquisto.</p>
                    `
                },
                {
                    id: 'capitolo-2',
                    title: 'Elasticità della Domanda',
                    description: `
                        <p>L'<strong>Elasticità della domanda rispetto al prezzo</strong> <span class="inline-math">$E_{d,p}$</span> misura l'intensità con cui varia la quantità domandata al variare del prezzo. In altre parole: quanto sono sensibili i consumatori ai cambiamenti di prezzo?</p>
                        
                        <div class="formula-box">
                            <span class="formula-label">Elasticità della Domanda</span>
                            <div class="formula-main">$$E_{d,p} = \\frac{\\Delta\\% \\, Q}{\\Delta\\% \\, P}$$</div>
                            <div class="formula-description">Rapporto tra variazione percentuale della quantità e variazione percentuale del prezzo</div>
                        </div>

                        <h4>Esempio Pratico (Mercato delle Mele)</h4>
                        
                        <div class="var-definition">
                            <div class="var-row">
                                <span class="var-symbol">$P_1 = 1€$</span>
                                <span class="var-meaning">Prezzo iniziale per kg</span>
                            </div>
                            <div class="var-row">
                                <span class="var-symbol">$Q_1 = 10 \\text{ kg}$</span>
                                <span class="var-meaning">Quantità iniziale acquistata</span>
                            </div>
                            <div class="var-row">
                                <span class="var-symbol">$P_2 = 1{,}60€$</span>
                                <span class="var-meaning">Nuovo prezzo per kg</span>
                            </div>
                            <div class="var-row">
                                <span class="var-symbol">$Q_2 = 7 \\text{ kg}$</span>
                                <span class="var-meaning">Nuova quantità acquistata</span>
                            </div>
                        </div>

                        <div class="math-steps">
                            <div class="math-step">
                                <span class="step-number">1</span>
                                <div class="step-content">
                                    <div class="step-label">Variazione del prezzo</div>
                                    $\\Delta P = P_2 - P_1 = 1{,}60 - 1 = +0{,}60€$<br>
                                    <small style="color: var(--accent-color)">→ +60%</small>
                                </div>
                            </div>
                            <div class="math-step">
                                <span class="step-number">2</span>
                                <div class="step-content">
                                    <div class="step-label">Variazione della quantità</div>
                                    $\\Delta Q = Q_2 - Q_1 = 7 - 10 = -3 \\text{ kg}$<br>
                                    <small style="color: var(--accent-color)">→ -30%</small>
                                </div>
                            </div>
                            <div class="math-step">
                                <span class="step-number">3</span>
                                <div class="step-content">
                                    <div class="step-label">Calcolo elasticità</div>
                                    $E_{d,p} = \\frac{30\\%}{60\\%} = 0{,}5$
                                </div>
                            </div>
                        </div>

                        <div class="math-result">
                            <span class="math-result-icon">✓</span>
                            <div class="math-result-content">
                                <span>$E_{d,p} = 0{,}5 < 1$</span>
                                <span>→ Domanda <strong>Anelastica</strong></span>
                            </div>
                        </div>

                        <div class="flip-container">
                            <div class="flip-card-inner">
                                <div class="flip-front">
                                    <div class="flip-title">Tipi di Elasticità</div>
                                    <div class="flip-hint">Tocca per scoprire i valori</div>
                                </div>
                                <div class="flip-back">
                                    <ul>
                                        <li>
                                            <span class="elasticity-type">Rigida $E = 0$</span>
                                            <span class="elasticity-desc">La domanda non cambia mai (es. farmaci salvavita). Curva verticale.</span>
                                        </li>
                                        <li>
                                            <span class="elasticity-type">Anelastica $E < 1$</span>
                                            <span class="elasticity-desc">Reazione debole (beni di prima necessità).</span>
                                        </li>
                                        <li>
                                            <span class="elasticity-type">Unitaria $E = 1$</span>
                                            <span class="elasticity-desc">Variazione proporzionale.</span>
                                        </li>
                                        <li>
                                            <span class="elasticity-type">Elastica $E > 1$</span>
                                            <span class="elasticity-desc">Forte reazione (beni di lusso).</span>
                                        </li>
                                        <li>
                                            <span class="elasticity-type">Infinita $E = \\infty$</span>
                                            <span class="elasticity-desc">Curva orizzontale.</span>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    `,
                    storyDescription: `
                        <p>Torniamo al supermercato. Abbiamo visto che compri meno mele se il prezzo sale. Ma <em>quanto</em> meno?</p>
                        <p>Se il prezzo dell'insulina per un diabetico raddoppia, il paziente continuerà a comprarne esattamente la stessa quantità per sopravvivere. Questa è una domanda <strong>Rigida</strong>: il consumatore è ostaggio del bisogno.</p>
                        <p>Se invece raddoppia il prezzo di un profumo di lusso, probabilmente smetterai del tutto di comprarlo. Questa è una domanda <strong>Elastica</strong>: puoi facilmente rinunciare o cambiare marca.</p>
                        <p>Nel nostro esempio delle mele, il prezzo è aumentato molto (+60%), ma tu hai ridotto l'acquisto solo un po' (-30%). Ti piacciono troppo le mele per rinunciarvi del tutto. La tua domanda è <strong>Anelastica</strong>.</p>
                    `
                },
                {
                    id: 'capitolo-3',
                    title: "L'Offerta di Mercato",
                    description: `
                        <p>L'<strong>Offerta</strong> è la quantità di beni o servizi che le imprese (produttori) sono disposte a vendere in un certo mercato a un certo prezzo.</p>
                        
                        <h4>La Legge dell'Offerta</h4>
                        <p>Esiste una <strong>relazione diretta</strong> tra prezzo e quantità offerta. Se il prezzo di mercato aumenta, i produttori sono incentivati a produrre di più per guadagnare di più.</p>

                        <div class="formula-box">
                            <span class="formula-label">Legge dell'Offerta</span>
                            <div class="formula-main">$$P \\uparrow \\;\\Rightarrow\\; Q_s \\uparrow \\quad \\text{e} \\quad P \\downarrow \\;\\Rightarrow\\; Q_s \\downarrow$$</div>
                            <div class="formula-description">All'aumentare del prezzo, la quantità offerta aumenta</div>
                        </div>

                        <div class="interactive-accordion">
                            <div class="acc-item">
                                <button class="acc-header">Fattori che influenzano l'offerta <span class="acc-icon">+</span></button>
                                <div class="acc-body"><div class="acc-content">
                                    <ul>
                                        <li><strong>Costi di produzione:</strong> Se aumentano i costi (materie prime, salari), l'offerta diminuisce (la curva si sposta a sinistra).</li>
                                        <li><strong>Tecnologia:</strong> Nuove tecnologie riducono i costi e aumentano l'offerta.</li>
                                        <li><strong>Clima:</strong> Fondamentale per l'agricoltura. Un clima favorevole aumenta l'offerta.</li>
                                        <li><strong>Leggi e Tasse:</strong> Regolamentazioni o incentivi statali.</li>
                                        <li><strong>Periodo:</strong>
                                            <ul>
                                                <li><em>Breve Periodo:</em> L'offerta è rigida (non si possono costruire nuove fabbriche in un giorno).</li>
                                                <li><em>Lungo Periodo:</em> L'offerta è elastica (si possono ampliare gli impianti).</li>
                                            </ul>
                                        </li>
                                    </ul>
                                </div></div>
                            </div>
                        </div>
                    `,
                    storyDescription: `
                        <p>Cambiamo prospettiva. Ora non sei più chi compra, sei <strong>L'Imprenditore</strong>. Possiedi una fabbrica di scarpe.</p>
                        <p>Se il prezzo delle scarpe sul mercato sale da 50€ a 100€, i tuoi occhi brillano. Vuoi vendere il più possibile! Assumi nuovi operai, fai straordinari, spingi le macchine al massimo. Ecco la <strong>Legge dell'Offerta</strong>: prezzo alto = più produzione.</p>
                        <p>Ma attenzione agli ostacoli. Se il prezzo del cuoio (costo di produzione) raddoppia, i tuoi margini si riducono e sarai costretto a produrre meno. Se invece inventano un robot che cuce le scarpe in metà tempo (nuova tecnologia), potrai inondare il mercato di scarpe a basso costo.</p>
                    `
                },
                {
                    id: 'capitolo-4',
                    title: "Elasticità dell'Offerta",
                    description: `
                        <p>Anche per l'offerta calcoliamo l'elasticità <span class="inline-math">$E_{o,p}$</span>, che misura la reattività dei produttori alle variazioni di prezzo.</p>
                        
                        <div class="formula-box">
                            <span class="formula-label">Elasticità dell'Offerta</span>
                            <div class="formula-main">$$E_{o,p} = \\frac{\\Delta\\% \\, Q_s}{\\Delta\\% \\, P}$$</div>
                            <div class="formula-description">Rapporto tra variazione percentuale della quantità offerta e del prezzo</div>
                        </div>

                        <h4>Esempio Pratico (Pastificio)</h4>

                        <div class="var-definition">
                            <div class="var-row">
                                <span class="var-symbol">$P_1 = 0{,}80€$</span>
                                <span class="var-meaning">Prezzo iniziale per kg</span>
                            </div>
                            <div class="var-row">
                                <span class="var-symbol">$Q_1 = 20.000$</span>
                                <span class="var-meaning">Quantità prodotta iniziale (kg)</span>
                            </div>
                            <div class="var-row">
                                <span class="var-symbol">$P_2 = 1{,}00€$</span>
                                <span class="var-meaning">Nuovo prezzo per kg</span>
                            </div>
                            <div class="var-row">
                                <span class="var-symbol">$Q_2 = 25.000$</span>
                                <span class="var-meaning">Nuova quantità prodotta (kg)</span>
                            </div>
                        </div>

                        <div class="math-steps">
                            <div class="math-step">
                                <span class="step-number">1</span>
                                <div class="step-content">
                                    <div class="step-label">Variazione % del prezzo</div>
                                    $\\Delta\\% P = \\frac{0{,}20}{0{,}80} \\times 100 = 25\\%$
                                </div>
                            </div>
                            <div class="math-step">
                                <span class="step-number">2</span>
                                <div class="step-content">
                                    <div class="step-label">Variazione % della quantità</div>
                                    $\\Delta\\% Q = \\frac{5.000}{20.000} \\times 100 = 25\\%$
                                </div>
                            </div>
                            <div class="math-step">
                                <span class="step-number">3</span>
                                <div class="step-content">
                                    <div class="step-label">Calcolo elasticità</div>
                                    $E_{o,p} = \\frac{25\\%}{25\\%} = 1$
                                </div>
                            </div>
                        </div>

                        <div class="math-result">
                            <span class="math-result-icon">✓</span>
                            <div class="math-result-content">
                                <span>$E_{o,p} = 1$</span>
                                <span>→ Elasticità <strong>Unitaria</strong></span>
                            </div>
                        </div>
                    `,
                    storyDescription: `
                        <p>Torniamo alla tua fabbrica. Il prezzo delle scarpe sale del 25%. Tu quanto riesci ad aumentare la produzione?</p>
                        <p>Se hai macchinari spenti pronti all'uso, potresti aumentare la produzione esattamente del 25%. In questo caso la tua reazione è perfettamente proporzionale (Elasticità Unitaria, come nell'esempio della pasta).</p>
                        <p>Ma se la tua fabbrica è già al 100% della capacità, anche se il prezzo raddoppia, tu non puoi produrre una scarpa in più nell'immediato. Nel <strong>breve periodo</strong>, la tua offerta è rigida (anelastica). Ti serve tempo per costruire un nuovo capannone (lungo periodo) e rendere l'offerta elastica.</p>
                    `
                },
                {
                    id: 'capitolo-5',
                    title: "Equilibrio di Mercato",
                    description: `
                        <p>Il mercato raggiunge l'<strong>Equilibrio</strong> quando la quantità domandata dai consumatori eguaglia la quantità offerta dai produttori.</p>
                        
                        <div class="formula-box">
                            <span class="formula-label">Condizione di Equilibrio</span>
                            <div class="formula-main">$$Q_d(P^*) = Q_s(P^*)$$</div>
                            <div class="formula-description">Al prezzo di equilibrio P*, domanda e offerta si eguagliano</div>
                        </div>

                        <p>Graficamente, è il punto di intersezione tra la curva di domanda (decrescente) e la curva di offerta (crescente).</p>
                        
                        <div class="var-definition">
                            <div class="var-row">
                                <span class="var-symbol">$P^*$</span>
                                <span class="var-meaning">Prezzo di equilibrio</span>
                            </div>
                            <div class="var-row">
                                <span class="var-symbol">$Q^*$</span>
                                <span class="var-meaning">Quantità di equilibrio</span>
                            </div>
                            <div class="var-row">
                                <span class="var-symbol">$Q_d > Q_s$</span>
                                <span class="var-meaning">Eccesso di domanda → prezzo sale ↑</span>
                            </div>
                            <div class="var-row">
                                <span class="var-symbol">$Q_d < Q_s$</span>
                                <span class="var-meaning">Eccesso di offerta → prezzo scende ↓</span>
                            </div>
                        </div>

                        <ul>
                            <li><strong>Prezzo di Equilibrio:</strong> Il prezzo in cui non c'è né eccesso di domanda (scaffali vuoti) né eccesso di offerta (magazzini pieni).</li>
                            <li><strong>Eccesso di Offerta:</strong> Se il prezzo è troppo alto, i venditori vogliono vendere molto, ma i compratori scappano. Il prezzo dovrà scendere.</li>
                            <li><strong>Eccesso di Domanda:</strong> Se il prezzo è troppo basso, tutti vogliono comprare, ma la merce finisce subito. Il prezzo tenderà a salire.</li>
                        </ul>
                        <p>Nel breve periodo i prezzi sono influenzati soprattutto dalla domanda, mentre nel lungo periodo sono influenzati anche dall'offerta.</p>
                    `,
                    storyDescription: `
                        <p>Immagina un'asta silenziosa. Da una parte ci sono i compratori (Domanda) che vogliono spendere poco. Dall'altra i venditori (Offerta) che vogliono guadagnare tanto.</p>
                        <p>Se il prezzo è troppo alto, i venditori portano tonnellate di merce, ma nessuno compra. La merce marcisce. Per liberarsene, devono abbassare il prezzo.</p>
                        <p>Se il prezzo è troppo basso, la gente si accalca e la merce finisce in un'ora. Chi è rimasto senza è disposto a pagare di più pur di averla. Il prezzo sale.</p>
                        <p>Alla fine, si arriva a un punto magico: l'<strong>Equilibrio</strong>. A quel prezzo preciso, tutto ciò che viene prodotto viene comprato. Nessuno resta insoddisfatto, niente viene sprecato. È la mano invisibile del mercato.</p>
                    `
                }
            ]
        };

        /* 
           =================================================================
           QUIZ (Con formule LaTeX)
           =================================================================
        */
        const quizData = [
            // -------------------------------------------------------------------------
            // SEZIONE 1: CONCETTI FONDAMENTALI DELLA DOMANDA (DEFINIZIONI E LEGGE)
            // -------------------------------------------------------------------------
            {
                question: "Qual è la definizione esatta di 'Domanda di mercato'?",
                options: [
                    "La quantità di beni e servizi che il consumatore è disposto ad acquistare in un certo mercato, in un certo tempo, a un certo prezzo",
                    "La quantità di beni che i produttori desiderano vendere per massimizzare il profitto",
                    "Il volume totale delle vendite effettuate in un negozio in un anno",
                    "La somma dei desideri illimitati dei consumatori indipendentemente dal prezzo"
                ],
                correctAnswer: "La quantità di beni e servizi che il consumatore è disposto ad acquistare in un certo mercato, in un certo tempo, a un certo prezzo",
                explanation: "La domanda non è un semplice desiderio, ma una volontà d'acquisto supportata dalla capacità di pagare, definita in base a mercato, tempo e prezzo specifici."
            },
            {
                question: "Cosa enuncia la 'Legge della domanda'?",
                options: [
                    "La domanda di un bene è inversamente proporzionale al suo prezzo",
                    "La domanda di un bene è direttamente proporzionale al suo prezzo",
                    "La domanda di un bene non varia al variare del prezzo",
                    "La domanda dipende esclusivamente dal reddito e non dal prezzo"
                ],
                correctAnswer: "La domanda di un bene è inversamente proporzionale al suo prezzo",
                explanation: "All'aumentare del prezzo di un bene, la sua domanda decresce, e viceversa. Questa relazione inversa è il pilastro della teoria della domanda."
            },
            {
                question: "Graficamente, come si presenta generalmente la curva di domanda?",
                options: [
                    "Decrescente da sinistra verso destra",
                    "Crescente da sinistra verso destra",
                    "Una linea retta orizzontale",
                    "Una linea retta verticale"
                ],
                correctAnswer: "Decrescente da sinistra verso destra",
                explanation: "Poiché la relazione tra prezzo (asse Y) e quantità (asse X) è inversa, la pendenza della curva è negativa."
            },
            {
                question: "Quali sono le variabili sugli assi cartesiani nel grafico della domanda?",
                options: [
                    "Prezzo sull'asse delle ordinate (Y) e Quantità sull'asse delle ascisse (X)",
                    "Quantità sull'asse delle ordinate (Y) e Prezzo sull'asse delle ascisse (X)",
                    "Reddito sull'asse delle ordinate (Y) e Quantità sull'asse delle ascisse (X)",
                    "Tempo sull'asse delle ordinate (Y) e Prezzo sull'asse delle ascisse (X)"
                ],
                correctAnswer: "Prezzo sull'asse delle ordinate (Y) e Quantità sull'asse delle ascisse (X)",
                explanation: "Per convenzione economica, il prezzo (variabile indipendente nel modello teorico causale, ma dipendente nel grafico marshalliano) è sulle ordinate, la quantità sulle ascisse."
            },
            {
                question: "Se il prezzo di un bene aumenta, cosa accade alla quantità domandata (ceteris paribus)?",
                options: [
                    "Diminuisce",
                    "Aumenta",
                    "Resta invariata",
                    "Diventa infinita"
                ],
                correctAnswer: "Diminuisce",
                explanation: "È l'applicazione diretta della legge della domanda: prezzo più alto disincentiva l'acquisto."
            },
            {
                question: "Se il prezzo di un bene diminuisce, cosa accade alla quantità domandata?",
                options: [
                    "Aumenta",
                    "Diminuisce",
                    "Resta costante",
                    "Si azzera"
                ],
                correctAnswer: "Aumenta",
                explanation: "Prezzi più bassi rendono il bene accessibile a più consumatori o incentivano acquisti maggiori da parte degli stessi consumatori."
            },

            // -------------------------------------------------------------------------
            // SEZIONE 2: FATTORI CHE INFLUENZANO LA DOMANDA (ESCLUSO IL PREZZO)
            // -------------------------------------------------------------------------
            {
                question: "Quale dei seguenti NON è citato come fattore che influenza la domanda?",
                options: [
                    "Costo di produzione",
                    "Reddito del consumatore",
                    "Gusti personali",
                    "Pubblicità"
                ],
                correctAnswer: "Costo di produzione",
                explanation: "Il costo di produzione influenza l'OFFERTA (le imprese), non direttamente la domanda (i consumatori)."
            },
            {
                question: "Come influiscono i 'gusti personali' sulla domanda?",
                options: [
                    "Possono aumentare o diminuire la domanda indipendentemente dal prezzo",
                    "Non hanno alcuna influenza",
                    "Determinano solo l'offerta",
                    "Sono rilevanti solo per i beni di lusso"
                ],
                correctAnswer: "Possono aumentare o diminuire la domanda indipendentemente dal prezzo",
                explanation: "Se un prodotto diventa di moda o incontra i gusti del consumatore, la sua domanda aumenta a parità di prezzo."
            },
            {
                question: "Che ruolo gioca la pubblicità nella domanda di un bene?",
                options: [
                    "Crea bisogni indotti influenzando le abitudini di acquisto",
                    "Riduce il prezzo del bene",
                    "Aumenta i costi di produzione riducendo l'offerta",
                    "Non ha effetti significativi nel breve periodo"
                ],
                correctAnswer: "Crea bisogni indotti influenzando le abitudini di acquisto",
                explanation: "La pubblicità serve a spostare la curva di domanda verso destra, aumentando il desiderio del consumatore per quel bene."
            },
            {
                question: "Cosa si intende per 'Packaging' tra i fattori della domanda?",
                options: [
                    "L'aspetto esteriore e la confezione del prodotto che può attrarre il consumatore",
                    "Il costo del trasporto del bene",
                    "La quantità di prodotto contenuta nella confezione",
                    "Il materiale di scarto della produzione"
                ],
                correctAnswer: "L'aspetto esteriore e la confezione del prodotto che può attrarre il consumatore",
                explanation: "Un packaging curato è una leva di marketing che influenza i gusti e quindi la domanda del consumatore."
            },
            {
                question: "Come varia generalmente la domanda al variare del reddito?",
                options: [
                    "Più è alto il reddito, più è alta la domanda (per la maggior parte dei beni)",
                    "Più è alto il reddito, più è bassa la domanda",
                    "Il reddito non influenza la quantità domandata",
                    "La domanda aumenta solo se il reddito diminuisce"
                ],
                correctAnswer: "Più è alto il reddito, più è alta la domanda (per la maggior parte dei beni)",
                explanation: "Un maggiore potere d'acquisto permette al consumatore di comprare maggiori quantità di beni e servizi."
            },
            {
                question: "Cos'è un 'bene inferiore'?",
                options: [
                    "Un bene di scarsa qualità la cui domanda diminuisce all'aumentare del reddito",
                    "Un bene che costa meno di 1 euro",
                    "Un bene prodotto all'estero",
                    "Un bene complementare alla benzina"
                ],
                correctAnswer: "Un bene di scarsa qualità la cui domanda diminuisce all'aumentare del reddito",
                explanation: "Quando il consumatore diventa più ricco, abbandona i beni inferiori (es. fagioli in scatola di bassa qualità) per passare a beni superiori (es. carne o pesce)."
            },
            {
                question: "Quale esempio viene fornito per spiegare i beni inferiori?",
                options: [
                    "Fagioli rispetto a carne/pesce",
                    "Auto rispetto a bici",
                    "Oro rispetto all'argento",
                    "Smartphone rispetto a telefoni fissi"
                ],
                correctAnswer: "Fagioli rispetto a carne/pesce",
                explanation: "L'esempio classico mostra una famiglia povera che consuma molti fagioli; arricchendosi, riduce i fagioli per comprare carne."
            },
            {
                question: "Cosa accade alla domanda di beni 'completamente soddisfatti' (bisogni saturi) all'aumentare del reddito?",
                options: [
                    "Si mantengono stabili",
                    "Aumentano esponenzialmente",
                    "Diminuiscono drasticamente",
                    "Diventano negativi"
                ],
                correctAnswer: "Si mantengono stabili",
                explanation: "Se un bisogno è già totalmente soddisfatto (es. la quantità di sale o pane necessaria), un aumento di reddito non ne fa aumentare ulteriormente il consumo."
            },
            {
                question: "Qual è la definizione di 'Beni succedanei'?",
                options: [
                    "Beni che possono essere usati l'uno al posto dell'altro (sostituti)",
                    "Beni che devono essere usati insieme",
                    "Beni che non hanno alcuna relazione tra loro",
                    "Beni di lusso"
                ],
                correctAnswer: "Beni che possono essere usati l'uno al posto dell'altro (sostituti)",
                explanation: "I succedanei soddisfano lo stesso bisogno. Se non ho il bene A, posso usare il bene B."
            },
            {
                question: "Quale coppia è un esempio di beni succedanei?",
                options: [
                    "Burro e Margarina",
                    "Caffè e Zucchero",
                    "Auto e Benzina",
                    "Software e Computer"
                ],
                correctAnswer: "Burro e Margarina",
                explanation: "Burro e margarina sono interscambiabili per molti usi culinari. Se il prezzo del burro sale, la domanda di margarina tende a salire."
            },
            {
                question: "Qual è la definizione di 'Beni complementari'?",
                options: [
                    "Beni che devono essere utilizzati insieme per soddisfare un bisogno",
                    "Beni che si escludono a vicenda",
                    "Beni prodotti dalla stessa azienda",
                    "Beni con la stessa elasticità"
                ],
                correctAnswer: "Beni che devono essere utilizzati insieme per soddisfare un bisogno",
                explanation: "L'uso dell'uno richiede l'uso dell'altro (es. l'auto non funziona senza benzina)."
            },
            {
                question: "Quale coppia è un esempio di beni complementari?",
                options: [
                    "Auto e Benzina",
                    "Tè e Caffè",
                    "Mele e Pere",
                    "Olio d'oliva e Olio di semi"
                ],
                correctAnswer: "Auto e Benzina",
                explanation: "La benzina è necessaria per far funzionare l'auto; la domanda di una influenza l'altra."
            },
            {
                question: "Se il prezzo della benzina aumenta notevolmente, cosa succede alla domanda di Auto?",
                options: [
                    "Diminuisce",
                    "Aumenta",
                    "Resta invariata",
                    "Diventa infinitamente elastica"
                ],
                correctAnswer: "Diminuisce",
                explanation: "Essendo beni complementari, l'aumento del costo di utilizzo (benzina) scoraggia l'acquisto del bene principale (auto)."
            },
            {
                question: "Se il prezzo del Burro aumenta, cosa succede alla domanda di Margarina?",
                options: [
                    "Aumenta",
                    "Diminuisce",
                    "Resta invariata",
                    "Si azzera"
                ],
                correctAnswer: "Aumenta",
                explanation: "I consumatori sostituiscono il bene diventato più caro (burro) con il sostituto più economico (margarina)."
            },

            // -------------------------------------------------------------------------
            // SEZIONE 3: ELASTICITÀ DELLA DOMANDA (CALCOLO E TIPI)
            // -------------------------------------------------------------------------
            {
                question: "Cosa misura l'elasticità della domanda rispetto al prezzo (Edp)?",
                options: [
                    "L'intensità della variazione della quantità domandata al variare del prezzo",
                    "La somma totale spesa dai consumatori",
                    "La differenza in euro tra due prezzi",
                    "Il tempo necessario affinché il mercato reagisca"
                ],
                correctAnswer: "L'intensità della variazione della quantità domandata al variare del prezzo",
                explanation: "Indica 'con quanta forza' reagiscono i consumatori a un cambiamento di prezzo."
            },
            {
                question: "Qual è la formula matematica base per il coefficiente di elasticità della domanda (Edp)?",
                options: [
                    "Edp = (Variazione % della Quantità) / (Variazione % del Prezzo)",
                    "Edp = (Variazione % del Prezzo) / (Variazione % della Quantità)",
                    "Edp = Prezzo / Quantità",
                    "Edp = Quantità finale - Quantità iniziale"
                ],
                correctAnswer: "Edp = (Variazione % della Quantità) / (Variazione % del Prezzo)",
                explanation: "È il rapporto tra la reazione percentuale della quantità e l'impulso percentuale del prezzo."
            },
            {
                question: "In termini di formula simbolica, come si scrive l'elasticità?",
                options: [
                    "Edp = Δ%Q / Δ%P",
                    "Edp = ΔP / ΔQ",
                    "Edp = Q1 + Q2",
                    "Edp = P x Q"
                ],
                correctAnswer: "Edp = Δ%Q / Δ%P",
                explanation: "Dove Δ (Delta) indica la variazione e % indica che è calcolata in termini percentuali."
            },
            {
                question: "Se Edp = 0, come viene definita la domanda?",
                options: [
                    "Rigida",
                    "Elastica",
                    "Unitaria",
                    "Infinitamente elastica"
                ],
                correctAnswer: "Rigida",
                explanation: "Una domanda rigida significa che la quantità domandata non cambia affatto al variare del prezzo (es. farmaci salvavita)."
            },
            {
                question: "Se il coefficiente Edp è minore di 1 (ma maggiore di 0), la domanda è:",
                options: [
                    "Anelastica",
                    "Elastica",
                    "Unitaria",
                    "Perfettamente elastica"
                ],
                correctAnswer: "Anelastica",
                explanation: "La variazione percentuale della quantità è inferiore alla variazione percentuale del prezzo (reazione debole)."
            },
            {
                question: "In una domanda anelastica (Edp < 1), quale relazione c'è tra ΔP e ΔQ?",
                options: [
                    "ΔP > ΔQ (La variazione del prezzo è maggiore della variazione della quantità)",
                    "ΔP < ΔQ",
                    "ΔP = ΔQ",
                    "ΔQ è infinita"
                ],
                correctAnswer: "ΔP > ΔQ (La variazione del prezzo è maggiore della variazione della quantità)",
                explanation: "Il prezzo cambia molto, ma la quantità reagisce poco."
            },
            {
                question: "Se Edp = 1, come viene definita l'elasticità?",
                options: [
                    "Elasticità Unitaria",
                    "Rigida",
                    "Neutrale",
                    "Inversa"
                ],
                correctAnswer: "Elasticità Unitaria",
                explanation: "La variazione percentuale della quantità è esattamente identica alla variazione percentuale del prezzo."
            },
            {
                question: "In caso di elasticità unitaria, qual è la relazione tra ΔP e ΔQ?",
                options: [
                    "ΔP = ΔQ",
                    "ΔP > ΔQ",
                    "ΔP < ΔQ",
                    "Nessuna relazione"
                ],
                correctAnswer: "ΔP = ΔQ",
                explanation: "Le due variazioni percentuali si equivalgono."
            },
            {
                question: "Se Edp > 1, la domanda è:",
                options: [
                    "Elastica",
                    "Rigida",
                    "Anelastica",
                    "Stabile"
                ],
                correctAnswer: "Elastica",
                explanation: "Una piccola variazione di prezzo provoca una grande reazione nella quantità domandata."
            },
            {
                question: "Quale tipo di beni tende ad avere una domanda Elastica (Edp > 1)?",
                options: [
                    "Beni di lusso (o non di prima necessità)",
                    "Beni di prima necessità",
                    "Farmaci salvavita",
                    "Sale e pane"
                ],
                correctAnswer: "Beni di lusso (o non di prima necessità)",
                explanation: "Per i beni superflui o di lusso (come profumi costosi), se il prezzo sale, il consumatore rinuncia facilmente all'acquisto."
            },
            {
                question: "Se Edp = ∞ (infinito), la domanda è:",
                options: [
                    "Infinitamente elastica",
                    "Totalmente rigida",
                    "Normalmente elastica",
                    "Unitaria"
                ],
                correctAnswer: "Infinitamente elastica",
                explanation: "Basta una variazione infinitesimale del prezzo per far crollare la domanda a zero o portarla all'infinito (caso teorico di concorrenza perfetta)."
            },
            {
                question: "Quale rappresentazione grafica corrisponde a una domanda Rigida (Edp=0)?",
                options: [
                    "Una linea verticale",
                    "Una linea orizzontale",
                    "Una curva decrescente",
                    "Una retta a 45 gradi"
                ],
                correctAnswer: "Una linea verticale",
                explanation: "La quantità (asse X) rimane fissa allo stesso punto qualunque sia il livello del prezzo (asse Y)."
            },
            {
                question: "Quale rappresentazione grafica corrisponde a una domanda Infinitamente Elastica?",
                options: [
                    "Una linea orizzontale",
                    "Una linea verticale",
                    "Una curva iperbolica",
                    "Una retta crescente"
                ],
                correctAnswer: "Una linea orizzontale",
                explanation: "A un solo livello di prezzo (fisso), i consumatori sono disposti ad acquistare quantità infinite."
            },
            {
                question: "Quali beni hanno tipicamente una domanda rigida?",
                options: [
                    "Beni di prima necessità (es. pane, medicinali)",
                    "Profumi",
                    "Automobili sportive",
                    "Vacanze"
                ],
                correctAnswer: "Beni di prima necessità (es. pane, medicinali)",
                explanation: "Il consumatore non può fare a meno di questi beni, quindi li acquista anche se il prezzo aumenta."
            },

            // -------------------------------------------------------------------------
            // SEZIONE 4: ESERCIZI DI CALCOLO SULLA DOMANDA (DATI DAGLI APPUNTI)
            // -------------------------------------------------------------------------
            {
                question: "Dati: P1 (mele) = 1€/kg, P2 = 1,60€/kg. Qual è la variazione assoluta di prezzo (ΔP)?",
                options: [
                    "0,60 €/kg",
                    "0,40 €/kg",
                    "1,00 €/kg",
                    "2,60 €/kg"
                ],
                correctAnswer: "0,60 €/kg",
                explanation: "ΔP = P2 - P1 = 1,60 - 1,00 = 0,60."
            },
            {
                question: "Dati: Q1 = 10kg, Q2 = 7kg. Qual è la variazione assoluta di quantità (ΔQ)?",
                options: [
                    "3 kg",
                    "7 kg",
                    "17 kg",
                    "10 kg"
                ],
                correctAnswer: "3 kg",
                explanation: "In valore assoluto (come spesso usato negli esercizi introduttivi), ΔQ = |7 - 10| = 3. La variazione è una diminuzione di 3 unità."
            },
            {
                question: "Usando i dati precedenti (P1=1, P2=1,60), qual è la variazione percentuale del prezzo?",
                options: [
                    "60%",
                    "30%",
                    "50%",
                    "100%"
                ],
                correctAnswer: "60%",
                explanation: "Calcolo: (0,60 / 1,00) * 100 = 60%."
            },
            {
                question: "Usando i dati precedenti (Q1=10, Q2=7), qual è la variazione percentuale della quantità?",
                options: [
                    "30%",
                    "70%",
                    "3%",
                    "10%"
                ],
                correctAnswer: "30%",
                explanation: "Calcolo: (3 / 10) * 100 = 30%."
            },
            {
                question: "Se la variazione % della quantità è 30% e la variazione % del prezzo è 60%, qual è l'elasticità (Edp)?",
                options: [
                    "0,5",
                    "2",
                    "1",
                    "0,2"
                ],
                correctAnswer: "0,5",
                explanation: "Edp = 30% / 60% = 0,5 (o 1/2)."
            },
            {
                question: "Con un'elasticità di 0,5, come classifichiamo questa domanda?",
                options: [
                    "Anelastica (o poco elastica)",
                    "Elastica",
                    "Unitaria",
                    "Infinita"
                ],
                correctAnswer: "Anelastica (o poco elastica)",
                explanation: "Poiché 0,5 è minore di 1, la domanda reagisce meno che proporzionalmente al prezzo."
            },

            // -------------------------------------------------------------------------
            // SEZIONE 5: CONCETTI FONDAMENTALI DELL'OFFERTA (DEFINIZIONI E LEGGE)
            // -------------------------------------------------------------------------
            {
                question: "Qual è la definizione di 'Offerta di mercato'?",
                options: [
                    "La quantità di beni e servizi che le imprese sono disposte a vendere in un certo mercato, momento e prezzo",
                    "La quantità di merce acquistata dai consumatori",
                    "Lo sconto applicato su un prodotto",
                    "L'insieme dei beni invenduti in magazzino"
                ],
                correctAnswer: "La quantità di beni e servizi che le imprese sono disposte a vendere in un certo mercato, momento e prezzo",
                explanation: "L'offerta rappresenta la volontà e capacità dei produttori di immettere merce sul mercato a date condizioni."
            },
            {
                question: "Cosa afferma la 'Legge dell'offerta'?",
                options: [
                    "All'aumentare del prezzo, l'offerta aumenta",
                    "All'aumentare del prezzo, l'offerta diminuisce",
                    "L'offerta è sempre costante",
                    "L'offerta dipende solo dalla domanda"
                ],
                correctAnswer: "All'aumentare del prezzo, l'offerta aumenta",
                explanation: "Esiste una relazione diretta: prezzi più alti incentivano i produttori a produrre di più per aumentare i profitti."
            },
            {
                question: "Perché la curva di offerta è crescente?",
                options: [
                    "Perché a prezzi più alti i venditori hanno maggiori incentivi a vendere e possono coprire costi maggiori",
                    "Perché i consumatori comprano di più se il prezzo sale",
                    "Perché i costi diminuiscono se il prezzo sale",
                    "È un errore grafico, dovrebbe essere decrescente"
                ],
                correctAnswer: "Perché a prezzi più alti i venditori hanno maggiori incentivi a vendere e possono coprire costi maggiori",
                explanation: "Il profitto atteso maggiore spinge le imprese ad aumentare la produzione e nuove imprese ad entrare nel mercato."
            },
            {
                question: "Cosa accade all'offerta se il prezzo diminuisce?",
                options: [
                    "Diminuisce",
                    "Aumenta",
                    "Resta uguale",
                    "Diventa negativa"
                ],
                correctAnswer: "Diminuisce",
                explanation: "I margini di profitto si riducono, quindi i produttori tagliano la produzione o escono dal mercato."
            },
            {
                question: "Graficamente, come si presenta la curva di offerta?",
                options: [
                    "Crescente da sinistra verso destra",
                    "Decrescente da sinistra verso destra",
                    "Verticale",
                    "A forma di U"
                ],
                correctAnswer: "Crescente da sinistra verso destra",
                explanation: "Parte bassa a sinistra (prezzo basso, quantità bassa) e sale verso destra (prezzo alto, quantità alta)."
            },

            // -------------------------------------------------------------------------
            // SEZIONE 6: FATTORI CHE INFLUENZANO L'OFFERTA
            // -------------------------------------------------------------------------
            {
                question: "Quale dei seguenti è un fattore chiave che influenza l'offerta (oltre al prezzo)?",
                options: [
                    "Costi dei fattori produttivi",
                    "Reddito del consumatore",
                    "Gusti del consumatore",
                    "Pubblicità rivolta al consumatore"
                ],
                correctAnswer: "Costi dei fattori produttivi",
                explanation: "Se produrre costa di più (materie prime, lavoro, energia), l'impresa offrirà meno prodotto a parità di prezzo di vendita."
            },
            {
                question: "Come influisce l'introduzione di 'nuove tecnologie' sull'offerta?",
                options: [
                    "Aumenta l'offerta riducendo i costi di produzione",
                    "Diminuisce l'offerta aumentando la complessità",
                    "Non ha effetti sulla produzione",
                    "Aumenta solo il prezzo di vendita"
                ],
                correctAnswer: "Aumenta l'offerta riducendo i costi di produzione",
                explanation: "L'innovazione tecnologica permette di produrre di più con meno risorse (efficienza), spostando la curva di offerta verso destra."
            },
            {
                question: "Quale effetto ha un clima favorevole sull'offerta di prodotti agricoli?",
                options: [
                    "La quantità offerta aumenta",
                    "La quantità offerta diminuisce",
                    "Il prezzo aumenta drasticamente",
                    "Nessun effetto"
                ],
                correctAnswer: "La quantità offerta aumenta",
                explanation: "In agricoltura, il clima è un fattore produttivo determinante. Buon clima = raccolto abbondante = maggiore offerta."
            },
            {
                question: "Se una legge impone costi aggiuntivi (es. impianti di bonifica obbligatori) alle imprese, cosa succede all'offerta?",
                options: [
                    "L'offerta diminuisce",
                    "L'offerta aumenta",
                    "L'offerta rimane invariata",
                    "La domanda aumenta"
                ],
                correctAnswer: "L'offerta diminuisce",
                explanation: "Costi più alti (per adeguarsi alle normative) riducono i margini, portando le imprese a produrre meno a parità di prezzo."
            },
            {
                question: "Cosa succede se lo Stato fornisce contributi (sussidi) alle imprese (es. per il biologico)?",
                options: [
                    "L'offerta aumenta",
                    "L'offerta diminuisce",
                    "I prezzi aumentano",
                    "Le imprese chiudono"
                ],
                correctAnswer: "L'offerta aumenta",
                explanation: "I sussidi riducono i costi effettivi per l'impresa, incentivando la produzione."
            },
            {
                question: "Quali sono i fattori elencati che influenzano l'offerta?",
                options: [
                    "Costi produttivi, tecnologia, clima, leggi, prezzo",
                    "Reddito, gusti, pubblicità",
                    "Solo il prezzo",
                    "Domanda estera e cambio valuta"
                ],
                correctAnswer: "Costi produttivi, tecnologia, clima, leggi, prezzo",
                explanation: "Questi sono i principali determinanti (shift factors) della curva di offerta."
            },

            // -------------------------------------------------------------------------
            // SEZIONE 7: ELASTICITÀ DELL'OFFERTA
            // -------------------------------------------------------------------------
            {
                question: "Cos'è l'elasticità dell'offerta?",
                options: [
                    "La misura di come varia l'offerta al variare del prezzo",
                    "La misura di come varia la domanda al variare dell'offerta",
                    "La velocità di produzione",
                    "Il margine di profitto"
                ],
                correctAnswer: "La misura di come varia l'offerta al variare del prezzo",
                explanation: "Analoga all'elasticità della domanda, ma dal lato del produttore: quanto reagiscono le imprese ai cambi di listino?"
            },
            {
                question: "Qual è la formula del coefficiente di elasticità dell'offerta (eop)?",
                options: [
                    "eop = (Variazione % Quantità Offerta) / (Variazione % Prezzo)",
                    "eop = Prezzo / Costo",
                    "eop = (Variazione % Prezzo) / (Variazione % Quantità Offerta)",
                    "eop = Ricavo Totale - Costo Totale"
                ],
                correctAnswer: "eop = (Variazione % Quantità Offerta) / (Variazione % Prezzo)",
                explanation: "Rapporto tra la reazione percentuale della quantità offerta e l'azione percentuale del prezzo."
            },
            {
                question: "Il coefficiente di elasticità dell'offerta è sempre:",
                options: [
                    "Positivo",
                    "Negativo",
                    "Zero",
                    "Indefinito"
                ],
                correctAnswer: "Positivo",
                explanation: "Poiché la curva di offerta è crescente (prezzo su -> quantità su), il rapporto tra due variazioni dello stesso segno è sempre positivo."
            },
            {
                question: "Se l'offerta è rigida, il coefficiente eop è:",
                options: [
                    "Uguale a 0",
                    "Minore di 1",
                    "Maggiore di 1",
                    "Infinito"
                ],
                correctAnswer: "Uguale a 0",
                explanation: "La quantità offerta non cambia affatto, qualunque sia il prezzo (es. periodo brevissimo, o quantità fissa come quadri di un pittore defunto)."
            },
            {
                question: "Se eop < 1, l'offerta è:",
                options: [
                    "Anelastica",
                    "Elastica",
                    "Rigida",
                    "Unitaria"
                ],
                correctAnswer: "Anelastica",
                explanation: "La variazione della quantità offerta è proporzionalmente inferiore alla variazione del prezzo."
            },
            {
                question: "In quale orizzonte temporale l'offerta tende ad essere più rigida/anelastica?",
                options: [
                    "Nel breve periodo",
                    "Nel lungo periodo",
                    "Sempre",
                    "Mai"
                ],
                correctAnswer: "Nel breve periodo",
                explanation: "Nel breve periodo le imprese non possono modificare facilmente gli impianti o la capacità produttiva, quindi faticano a rispondere a variazioni di prezzo."
            },
            {
                question: "In quale orizzonte temporale l'offerta tende ad essere più elastica?",
                options: [
                    "Nel lungo periodo",
                    "Nel breve periodo",
                    "Nell'immediato",
                    "Non dipende dal tempo"
                ],
                correctAnswer: "Nel lungo periodo",
                explanation: "Col tempo, le imprese possono costruire nuove fabbriche, assumere personale o acquistare macchinari, reagendo pienamente al prezzo."
            },
            {
                question: "Se eop > 1, l'offerta è:",
                options: [
                    "Elastica",
                    "Rigida",
                    "Neutra",
                    "Unitaria"
                ],
                correctAnswer: "Elastica",
                explanation: "Le imprese reagiscono con un grande aumento di produzione a un piccolo aumento di prezzo."
            },
            {
                question: "Un'offerta infinitamente elastica (eop = ∞) è rappresentata graficamente da:",
                options: [
                    "Una retta orizzontale",
                    "Una retta verticale",
                    "Una curva a 45 gradi",
                    "Una parabola"
                ],
                correctAnswer: "Una retta orizzontale",
                explanation: "A un determinato prezzo, l'impresa è disposta a offrire qualsiasi quantità. Sotto quel prezzo, nulla."
            },

            // -------------------------------------------------------------------------
            // SEZIONE 8: EQUILIBRIO DI MERCATO
            // -------------------------------------------------------------------------
            {
                question: "Cos'è il punto di equilibrio di mercato?",
                options: [
                    "Il punto in cui la curva di domanda e la curva di offerta si intersecano",
                    "Il punto in cui il prezzo è più alto possibile",
                    "Il punto in cui la quantità è zero",
                    "Il punto medio tra costo e ricavo"
                ],
                correctAnswer: "Il punto in cui la curva di domanda e la curva di offerta si intersecano",
                explanation: "È l'unica combinazione prezzo-quantità che soddisfa contemporaneamente consumatori e produttori."
            },
            {
                question: "Cosa rappresenta il 'prezzo di equilibrio'?",
                options: [
                    "Il prezzo che eguaglia la quantità offerta e la quantità domandata",
                    "Il prezzo imposto dallo Stato",
                    "Il prezzo medio di tutti i beni",
                    "Il prezzo che massimizza il profitto del monopolista"
                ],
                correctAnswer: "Il prezzo che eguaglia la quantità offerta e la quantità domandata",
                explanation: "A questo prezzo non c'è né eccesso di domanda (scarsità) né eccesso di offerta (surplus). Il mercato si 'pulisce' (market clearing)."
            },
            {
                question: "Se il prezzo di mercato è superiore al prezzo di equilibrio, cosa si verifica?",
                options: [
                    "Un eccesso di offerta (surplus)",
                    "Un eccesso di domanda (scarsità)",
                    "Un equilibrio stabile",
                    "Un aumento immediato della domanda"
                ],
                correctAnswer: "Un eccesso di offerta (surplus)",
                explanation: "A prezzi alti, i produttori offrono molto, ma i consumatori domandano poco. La merce resta invenduta."
            },
            {
                question: "Se c'è un eccesso di offerta, cosa tendono a fare i produttori?",
                options: [
                    "Abbassare il prezzo per smaltire le scorte",
                    "Alzare il prezzo per guadagnare di più",
                    "Aumentare ancora la produzione",
                    "Non fanno nulla"
                ],
                correctAnswer: "Abbassare il prezzo per smaltire le scorte",
                explanation: "La concorrenza per vendere la merce in eccesso spinge il prezzo verso il basso, ritornando verso l'equilibrio."
            },
            {
                question: "Se il prezzo di mercato è inferiore al prezzo di equilibrio, cosa si verifica?",
                options: [
                    "Un eccesso di domanda (scarsità)",
                    "Un eccesso di offerta",
                    "Le scorte aumentano",
                    "I consumatori smettono di comprare"
                ],
                correctAnswer: "Un eccesso di domanda (scarsità)",
                explanation: "A prezzi bassi, tutti vogliono comprare, ma i produttori offrono poco. I beni spariscono dagli scaffali."
            },
            {
                question: "Nel breve periodo, i prezzi sono influenzati soprattutto da:",
                options: [
                    "Dalla domanda",
                    "Dall'offerta",
                    "Dai costi fissi",
                    "Dalle tecnologie"
                ],
                correctAnswer: "Dalla domanda",
                explanation: "Poiché l'offerta è rigida nel breve periodo (non si può produrre di più subito), variazioni della domanda impattano subito sul prezzo."
            },
            {
                question: "Nel lungo periodo, i prezzi sono influenzati anche da:",
                options: [
                    "Dall'offerta",
                    "Solo dalla domanda",
                    "Solo dal clima",
                    "Non variano mai"
                ],
                correctAnswer: "Dall'offerta",
                explanation: "Nel lungo periodo l'offerta diventa elastica e si adatta, giocando un ruolo attivo nella determinazione del nuovo prezzo di equilibrio."
            },

            // -------------------------------------------------------------------------
            // SEZIONE 9: ESERCIZI DI CALCOLO SULL'OFFERTA (DATI DAGLI APPUNTI)
            // -------------------------------------------------------------------------
            {
                question: "Dati Offerta: P1 = 0,80 €, P2 = 1,00 €. Qual è ΔP?",
                options: [
                    "0,20 €",
                    "0,80 €",
                    "1,80 €",
                    "0,10 €"
                ],
                correctAnswer: "0,20 €",
                explanation: "ΔP = 1,00 - 0,80 = 0,20."
            },
            {
                question: "Dati Offerta: Q1 = 20.000 kg, Q2 = 25.000 kg. Qual è ΔQ?",
                options: [
                    "5.000 kg",
                    "45.000 kg",
                    "20.000 kg",
                    "25.000 kg"
                ],
                correctAnswer: "5.000 kg",
                explanation: "ΔQ = 25.000 - 20.000 = 5.000."
            },
            {
                question: "Calcola la variazione % del prezzo (P1=0,80, P2=1,00).",
                options: [
                    "25%",
                    "20%",
                    "50%",
                    "10%"
                ],
                correctAnswer: "25%",
                explanation: "Calcolo: (0,20 / 0,80) * 100. 0,20 è un quarto di 0,80, quindi 25%."
            },
            {
                question: "Calcola la variazione % della quantità offerta (Q1=20.000, Q2=25.000).",
                options: [
                    "25%",
                    "20%",
                    "50%",
                    "5%"
                ],
                correctAnswer: "25%",
                explanation: "Calcolo: (5.000 / 20.000) * 100. 5 su 20 è un quarto, quindi 25%."
            },
            {
                question: "Se Δ%Q = 25% e Δ%P = 25%, qual è il coefficiente di elasticità dell'offerta (eop)?",
                options: [
                    "1",
                    "0",
                    "0,5",
                    "25"
                ],
                correctAnswer: "1",
                explanation: "eop = 25 / 25 = 1. Si tratta di elasticità unitaria."
            },
            {
                question: "Un coefficiente eop = 1 indica:",
                options: [
                    "Elasticità Unitaria",
                    "Offerta Rigida",
                    "Offerta Elastica",
                    "Offerta Anelastica"
                ],
                correctAnswer: "Elasticità Unitaria",
                explanation: "L'offerta varia esattamente nella stessa proporzione del prezzo."
            },

            // -------------------------------------------------------------------------
            // SEZIONE 10: ELASTICITÀ INCROCIATA E REDDITO (APPROFONDIMENTI)
            // -------------------------------------------------------------------------
            {
                question: "Cosa misura l'elasticità incrociata?",
                options: [
                    "La variazione della domanda del bene A al variare del prezzo del bene B",
                    "La variazione della domanda al variare del reddito",
                    "La somma delle elasticità di due beni",
                    "L'incrocio tra domanda e offerta"
                ],
                correctAnswer: "La variazione della domanda del bene A al variare del prezzo del bene B",
                explanation: "Serve a capire la relazione tra due beni (se sono sostituti, complementari o indipendenti)."
            },
            {
                question: "Se l'elasticità incrociata è positiva, i due beni sono:",
                options: [
                    "Succedanei (Sostituti)",
                    "Complementari",
                    "Indipendenti",
                    "Inferiori"
                ],
                correctAnswer: "Succedanei (Sostituti)",
                explanation: "Se aumenta il prezzo di B (es. burro), aumenta la domanda di A (margarina). Segno positivo."
            },
            {
                question: "Se l'elasticità incrociata è negativa, i due beni sono:",
                options: [
                    "Complementari",
                    "Succedanei",
                    "Di lusso",
                    "Normali"
                ],
                correctAnswer: "Complementari",
                explanation: "Se aumenta il prezzo di B (benzina), diminuisce la domanda di A (auto). Segno negativo (relazione inversa)."
            },
            {
                question: "Se il reddito aumenta e la domanda di un bene diminuisce, quel bene è:",
                options: [
                    "Un bene inferiore",
                    "Un bene normale",
                    "Un bene di lusso",
                    "Un bene primario"
                ],
                correctAnswer: "Un bene inferiore",
                explanation: "È la definizione tecnica di bene inferiore (elasticità rispetto al reddito negativa)."
            },
            {
                question: "Se il reddito aumenta e la domanda di un bene aumenta, quel bene è:",
                options: [
                    "Un bene normale",
                    "Un bene inferiore",
                    "Un bene di Giffen",
                    "Un bene pubblico"
                ],
                correctAnswer: "Un bene normale",
                explanation: "La maggior parte dei beni sono normali: più soldi hai, più ne compri."
            },

            // -------------------------------------------------------------------------
            // SEZIONE 11: VARI SCENARI E DOMANDE DI RAGIONAMENTO
            // -------------------------------------------------------------------------
            {
                question: "Perché la curva di domanda dei beni inferiori può avere un andamento anomalo rispetto al reddito?",
                options: [
                    "Perché all'aumentare della ricchezza il consumatore preferisce beni di qualità superiore",
                    "Perché costano troppo",
                    "Perché non sono tassati",
                    "Perché sono beni importati"
                ],
                correctAnswer: "Perché all'aumentare della ricchezza il consumatore preferisce beni di qualità superiore",
                explanation: "L'effetto reddito negativo prevale: non ne compro di più, ne compro di meno per migliorare il mio standard di vita."
            },
            {
                question: "Esempio pratico: Se il prezzo delle mele passa da 1€ a 3€, e la domanda scende da 100kg a 20kg. Calcola elasticità approssimativa.",
                options: [
                    "Domanda elastica",
                    "Domanda rigida",
                    "Elasticità nulla",
                    "Domanda crescente"
                ],
                correctAnswer: "Domanda elastica",
                explanation: "Il prezzo triplica (+200%), la domanda crolla dell'80%. La reazione è forte, suggerendo elasticità."
            },
            {
                question: "Quale fattore può rendere la domanda di un bene più rigida?",
                options: [
                    "La mancanza di beni sostituti",
                    "La presenza di molti sostituti",
                    "Essere un bene di lusso",
                    "Avere un prezzo molto alto rispetto al reddito"
                ],
                correctAnswer: "La mancanza di beni sostituti",
                explanation: "Se non ci sono alternative (es. benzina in assenza di auto elettriche o mezzi pubblici), devo comprare per forza quel bene anche se il prezzo sale."
            },
            {
                question: "Quale fattore rende l'offerta più elastica?",
                options: [
                    "La facilità di immagazzinamento e la capacità produttiva inutilizzata",
                    "La piena occupazione delle risorse",
                    "La deperibilità immediata del prodotto",
                    "Costi fissi elevatissimi"
                ],
                correctAnswer: "La facilità di immagazzinamento e la capacità produttiva inutilizzata",
                explanation: "Se ho merce in magazzino o macchine ferme, posso rispondere subito a un aumento di prezzo aumentando l'offerta."
            },
            {
                question: "Nell'equilibrio di mercato grafico, l'eccesso di domanda si trova:",
                options: [
                    "Sotto il punto di equilibrio",
                    "Sopra il punto di equilibrio",
                    "A destra dell'equilibrio",
                    "Sulla curva di offerta"
                ],
                correctAnswer: "Sotto il punto di equilibrio",
                explanation: "Sotto il prezzo di equilibrio, il prezzo è troppo basso, quindi la quantità domandata (sulla curva di domanda) eccede quella offerta."
            },
            {
                question: "Nell'equilibrio di mercato grafico, l'eccesso di offerta si trova:",
                options: [
                    "Sopra il punto di equilibrio",
                    "Sotto il punto di equilibrio",
                    "A sinistra dell'equilibrio",
                    "Sull'asse delle ascisse"
                ],
                correctAnswer: "Sopra il punto di equilibrio",
                explanation: "Sopra il prezzo di equilibrio, il prezzo è troppo alto, quindi i produttori offrono più di quanto i consumatori chiedano."
            },

            // -------------------------------------------------------------------------
            // SEZIONE 12: DETTAGLI GRAFICI E TEORICI (MIX FINALE)
            // -------------------------------------------------------------------------
            {
                question: "Cosa indica lo spostamento dell'intera curva di domanda verso destra?",
                options: [
                    "Un aumento della domanda a parità di prezzo (es. per aumento reddito o moda)",
                    "Una diminuzione della domanda",
                    "Un movimento lungo la curva dovuto al calo del prezzo",
                    "Un aumento dell'offerta"
                ],
                correctAnswer: "Un aumento della domanda a parità di prezzo (es. per aumento reddito o moda)",
                explanation: "Significa che per ogni livello di prezzo, i consumatori ora vogliono comprare una quantità maggiore."
            },
            {
                question: "Cosa indica lo spostamento dell'intera curva di offerta verso sinistra?",
                options: [
                    "Una diminuzione dell'offerta (es. aumento costi produzione)",
                    "Un aumento dell'offerta",
                    "Un calo del prezzo di equilibrio",
                    "Un miglioramento tecnologico"
                ],
                correctAnswer: "Una diminuzione dell'offerta (es. aumento costi produzione)",
                explanation: "A parità di prezzo, le imprese offrono meno (o richiedono un prezzo più alto per offrire la stessa quantità)."
            },
            {
                question: "Il punto in cui la curva di domanda interseca l'asse delle ordinate (Prezzo) rappresenta:",
                options: [
                    "Il prezzo massimo che i consumatori sono disposti a pagare (prezzo di riserva)",
                    "La quantità massima acquistabile",
                    "Il costo di produzione nullo",
                    "L'equilibrio"
                ],
                correctAnswer: "Il prezzo massimo che i consumatori sono disposti a pagare (prezzo di riserva)",
                explanation: "Sopra quel prezzo, la domanda è zero."
            },
            {
                question: "Il punto in cui la curva di offerta parte dall'asse delle ordinate (o vicino all'origine) indica:",
                options: [
                    "Il prezzo minimo al di sotto del quale non c'è offerta",
                    "La capacità produttiva massima",
                    "Il profitto massimo",
                    "La domanda satura"
                ],
                correctAnswer: "Il prezzo minimo al di sotto del quale non c'è offerta",
                explanation: "Le imprese non producono se il prezzo non copre almeno certi costi variabili."
            },
            {
                question: "Se Edp = 1, una variazione del prezzo del 10% provoca:",
                options: [
                    "Una variazione della quantità del 10%",
                    "Una variazione della quantità dell'1%",
                    "Una variazione della quantità del 100%",
                    "Nessuna variazione"
                ],
                correctAnswer: "Una variazione della quantità del 10%",
                explanation: "Percentuali identiche caratterizzano l'elasticità unitaria."
            },
            {
                question: "Un esempio di domanda perfettamente rigida (linea verticale) potrebbe essere, in teoria:",
                options: [
                    "L'insulina per un diabetico (senza sostituti)",
                    "Un biglietto del cinema",
                    "Un pacchetto di gomme",
                    "Un'auto di lusso"
                ],
                correctAnswer: "L'insulina per un diabetico (senza sostituti)",
                explanation: "Il consumatore deve acquistarla a qualsiasi prezzo per sopravvivere (quantità fissa necessaria)."
            },
            {
                question: "Quando si dice che la domanda è 'funzione inversa' del prezzo, matematicamente significa che:",
                options: [
                    "La derivata (o pendenza) è negativa",
                    "La derivata è positiva",
                    "La funzione è esponenziale",
                    "La funzione è logaritmica crescente"
                ],
                correctAnswer: "La derivata (o pendenza) è negativa",
                explanation: "All'aumentare di X (quantità) il valore di Y (prezzo di domanda) scende, o viceversa."
            },
            {
                question: "Se il reddito dei consumatori raddoppia, cosa accade alla curva di domanda di auto nuove (bene normale)?",
                options: [
                    "Si sposta verso destra (in alto)",
                    "Si sposta verso sinistra (in basso)",
                    "Resta ferma",
                    "Diventa verticale"
                ],
                correctAnswer: "Si sposta verso destra (in alto)",
                explanation: "Più ricchezza = maggiore disponibilità a comprare auto a ogni dato prezzo."
            }
        ];

        /* ================================================================= */
        /* LOGICA APPLICAZIONE (CORE) */
        /* ================================================================= */

        class ScrollytellingApp {
            constructor(content) {
                this.content = content;
                this.lastScrollY = 0;
                this.isDragging = false;
                this.scrubTargetIndex = 0;
                this.isSnapEnabled = localStorage.getItem('snapEnabled') !== 'false'; 
                this.currentChapterIndex = 0;
                this.isSnapping = false; 
                
                this.initDOMElements();
                this.initEventListeners();
                this.initTheme();
                this.initSnapState();
                
                this.setMode(localStorage.getItem('template-mode') || 'study');
                this.dom.appContainer.classList.add('loaded');
            }
            
            initDOMElements() {
                this.dom = {
                    appContainer: document.getElementById('app'), header: document.getElementById('header'),
                    headerTitle: document.getElementById('header-title'), 
                    timelineNodesMobile: document.getElementById('timeline-nodes-mobile'),
                    timelineProgressMobile: document.getElementById('timeline-progress-mobile'),
                    timelineTrackMobile: document.getElementById('timeline-track-mobile'),
                    timelineNodesDesktop: document.getElementById('timeline-nodes-desktop'),
                    timelineProgressDesktop: document.getElementById('timeline-progress-desktop'),
                    timelineDesktopContainer: document.querySelector('.timeline-desktop-container'),
                    storyPanel: document.getElementById('story-panel'),
                    themeSwitcher: document.querySelector('.theme-switcher'),
                    scrollSentinel: document.getElementById('scroll-sentinel'),
                    modeBtns: document.querySelectorAll('.mode-btn'),
                    appFooter: document.getElementById('app-footer'),
                    autoScrollBtn: document.getElementById('autoscroll-btn'),
                    prevChapterBtn: document.getElementById('prev-chapter-btn'),
                    nextChapterBtn: document.getElementById('next-chapter-btn')
                };
            }
            
            initSnapState() {
                if (this.isSnapEnabled) {
                    this.dom.autoScrollBtn.classList.add('active');
                }
            }

            initTheme() {
                const savedTheme = localStorage.getItem('theme') || 'light'; 
                this.applyTheme(savedTheme);
                this.dom.themeSwitcher.addEventListener('click', () => {
                    if (navigator.vibrate) navigator.vibrate(20);
                    const newTheme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
                    this.applyTheme(newTheme);
                });
            }
            
            applyTheme(theme) {
                document.documentElement.setAttribute('data-theme', theme);
                localStorage.setItem('theme', theme);
            }
            
            initEventListeners() {
                if ('scrollRestoration' in history) { history.scrollRestoration = 'manual'; }
                window.scrollTo(0, 0);

                this.dom.modeBtns.forEach(btn => {
                    btn.addEventListener('click', () => {
                        if (navigator.vibrate) navigator.vibrate(20);
                        const newMode = btn.dataset.mode;
                        this.setMode(newMode);
                    });
                });
                
                this.dom.autoScrollBtn.addEventListener('click', () => {
                     this.isSnapEnabled = !this.isSnapEnabled;
                     localStorage.setItem('snapEnabled', this.isSnapEnabled);
                     this.dom.autoScrollBtn.classList.toggle('active');
                     if (navigator.vibrate) navigator.vibrate(10);
                     
                     if(this.isSnapEnabled) {
                         this.dom.header.classList.remove('hidden');
                         this.dom.appFooter.classList.remove('hidden');
                     }
                });

                this.dom.prevChapterBtn.addEventListener('click', () => {
                    if (this.currentChapterIndex > 0) {
                        this.scrollToChapter(this.content.chapters[this.currentChapterIndex - 1].id);
                    }
                });

                this.dom.nextChapterBtn.addEventListener('click', () => {
                    if (this.currentChapterIndex < this.content.chapters.length - 1) {
                        this.scrollToChapter(this.content.chapters[this.currentChapterIndex + 1].id);
                    }
                });

                window.addEventListener('scroll', () => this.handleScroll(), { passive: true });
                window.addEventListener('resize', () => this.handleResize());
                this.initDraggableTimeline();
            }
            
            handleScroll() {
                const currentScrollY = window.scrollY;
                const isMobile = window.innerWidth < 960;

                if (Math.abs(currentScrollY - this.lastScrollY) > 5) {
                    if (currentScrollY > this.lastScrollY && currentScrollY > 80) {
                        this.dom.header.classList.add('hidden');
                        this.dom.appFooter.classList.add('hidden');
                    } else {
                        this.dom.header.classList.remove('hidden');
                        this.dom.appFooter.classList.remove('hidden');
                    }
                }
                
                if (this.isSnapEnabled && !isMobile && !this.isSnapping) {
                    this.checkSnapTrigger();
                }

                this.lastScrollY = currentScrollY;
            }

            checkSnapTrigger() {
                const chapters = document.querySelectorAll('.story-chapter');
                const viewportHeight = window.innerHeight;
                const triggerPoint = viewportHeight / 1.5; 
                
                chapters.forEach((chapter, index) => {
                    const rect = chapter.getBoundingClientRect();
                    if (rect.bottom < triggerPoint && rect.bottom > 0 && index < chapters.length - 1) {
                        this.isSnapping = true;
                        const nextChapterId = chapters[index + 1].id;
                        this.scrollToChapter(nextChapterId);
                        setTimeout(() => { this.isSnapping = false; }, 1000);
                    }
                });
            }
            
            handleResize() {
                document.querySelectorAll('.acc-item.open .acc-body').forEach(body => {
                    body.style.maxHeight = body.scrollHeight + "px";
                });
                if(this.dom.timelineNodesDesktop.offsetHeight > 0) {
                    this.setupDesktopTimelineSVG();
                }
            }
            
            initDraggableTimeline() {
                const timeline = this.dom.timelineTrackMobile;
                const handleDrag = (e) => {
                    if (!this.isDragging) return;
                    e.preventDefault();
                    const clientX = e.clientX || e.touches[0].clientX;
                    const rect = timeline.getBoundingClientRect();
                    let progress = (clientX - rect.left) / rect.width;
                    progress = Math.max(0, Math.min(1, progress));
                    
                    this.scrubTargetIndex = Math.round(progress * (this.content.chapters.length - 1));
                    this.dom.headerTitle.textContent = this.content.chapters[this.scrubTargetIndex].title;
                    
                    document.querySelectorAll('.timeline-node-point').forEach((node, index) => {
                        node.classList.toggle('active', index === this.scrubTargetIndex);
                    });
                    this.dom.timelineProgressMobile.style.width = `${progress * 100}%`;
                };
                const startDrag = (e) => {
                    this.isDragging = true;
                    handleDrag(e);
                };
                const endDrag = () => {
                    if (!this.isDragging) return;
                    this.isDragging = false;
                    this.scrollToChapter(this.content.chapters[this.scrubTargetIndex].id);
                };
                timeline.addEventListener('mousedown', startDrag);
                window.addEventListener('mousemove', handleDrag);
                window.addEventListener('mouseup', endDrag);
                timeline.addEventListener('touchstart', startDrag, { passive: false });
                window.addEventListener('touchmove', handleDrag, { passive: false });
                window.addEventListener('touchend', endDrag);
            }
            
            setMode(mode) {
                localStorage.setItem('template-mode', mode);
                this.dom.modeBtns.forEach(b => b.classList.toggle('active', b.dataset.mode === mode));
                const currentScrollRatio = window.scrollY / (document.documentElement.scrollHeight - window.innerHeight);
                this.buildUI(mode);
                this.initObservers(); 
                const newScrollHeight = document.documentElement.scrollHeight - window.innerHeight;
                if(!isNaN(currentScrollRatio)) {
                     window.scrollTo(0, newScrollHeight * currentScrollRatio);
                }
            }
            
            buildUI(mode) {
                document.querySelector('.header-title').textContent = this.content.title;

                this.dom.storyPanel.innerHTML = '';
                this.dom.timelineNodesMobile.innerHTML = '';
                this.dom.timelineNodesDesktop.innerHTML = '';
                
                this.content.chapters.forEach(chapter => {
                    const nodePointMobile = document.createElement('button');
                    nodePointMobile.className = 'timeline-node-point';
                    nodePointMobile.dataset.targetId = chapter.id;
                    nodePointMobile.setAttribute('aria-label', `Vai al capitolo: ${chapter.title}`);
                    nodePointMobile.onclick = (e) => {
                        if(navigator.vibrate) navigator.vibrate(10);
                        this.scrollToChapter(chapter.id);
                    };
                    this.dom.timelineNodesMobile.appendChild(nodePointMobile);

                    const nodeDesktop = document.createElement('button');
                    nodeDesktop.className = 'timeline-desktop-node';
                    nodeDesktop.dataset.targetId = chapter.id;
                    nodeDesktop.innerHTML = `<div class="node-point"></div><div class="node-label">${chapter.title}</div>`;
                    nodeDesktop.onclick = () => this.scrollToChapter(chapter.id);
                    this.dom.timelineNodesDesktop.appendChild(nodeDesktop);

                    const section = document.createElement('section');
                    section.className = 'story-chapter';
                    section.id = chapter.id;
                    const content = mode === 'story' ? chapter.storyDescription : chapter.description;
                    section.innerHTML = `<div class="chapter-content"><h2 class="chapter-title">${chapter.title}</h2><div class="chapter-body">${content}</div></div>`;
                    this.dom.storyPanel.appendChild(section);
                });

                this.dom.storyPanel.querySelectorAll('.acc-header').forEach(header => {
                    header.addEventListener('click', () => {
                        const item = header.parentElement;
                        const body = header.nextElementSibling;
                        const isOpen = item.classList.contains('open');
                        item.classList.toggle('open');
                        if (!isOpen) {
                            body.style.maxHeight = body.scrollHeight + "px";
                        } else {
                            body.style.maxHeight = null;
                        }
                    });
                });

                this.dom.storyPanel.querySelectorAll('.flip-container').forEach(container => {
                    container.addEventListener('click', () => {
                         const selection = window.getSelection();
                         if (selection.toString().length === 0) {
                             container.classList.toggle('flipped');
                         }
                    });
                });
                
                this.setupDesktopTimelineSVG();
                
                // Render math with KaTeX
                this.renderMath();
            }
            
            renderMath() {
                if (typeof renderMathInElement !== 'undefined') {
                    renderMathInElement(document.body, {
                        delimiters: [
                            {left: '$$', right: '$$', display: true},
                            {left: '$', right: '$', display: false}
                        ],
                        throwOnError: false,
                        trust: true
                    });
                    
                    // Check for scrollable formulas and add hint
                    this.checkScrollableFormulas();
                } else {
                    // Wait for KaTeX to load
                    setTimeout(() => this.renderMath(), 100);
                }
            }
            
            checkScrollableFormulas() {
                document.querySelectorAll('.formula-main').forEach(el => {
                    if (el.scrollWidth > el.clientWidth) {
                        el.closest('.formula-box')?.classList.add('scrollable');
                    }
                });
            }
            
            setupDesktopTimelineSVG() {
                const nodesHeight = this.dom.timelineNodesDesktop.offsetHeight;
                const containerHeight = this.dom.timelineDesktopContainer.offsetHeight;
                const startY = (containerHeight - nodesHeight) / 2;
                const endY = startY + nodesHeight;

                const line = this.dom.timelineProgressDesktop.previousElementSibling;
                line.setAttribute('y1', startY);
                line.setAttribute('y2', endY);
                
                const progressLine = this.dom.timelineProgressDesktop;
                progressLine.setAttribute('y1', startY);
                progressLine.setAttribute('y2', endY);

                const pathLength = endY - startY;
                progressLine.style.strokeDasharray = pathLength;
                progressLine.style.strokeDashoffset = pathLength;
            }

            scrollToChapter(id) {
                const targetElement = document.getElementById(id);
                const headerOffset = 80;
                const elementPosition = targetElement.getBoundingClientRect().top;
                const offsetPosition = elementPosition + window.pageYOffset - headerOffset;
                window.scrollTo({ top: offsetPosition, behavior: 'smooth' });
            }
            
            updateNavButtonsState() {
                if (this.currentChapterIndex <= 0) {
                    this.dom.prevChapterBtn.classList.add('disabled');
                } else {
                    this.dom.prevChapterBtn.classList.remove('disabled');
                }

                if (this.currentChapterIndex >= this.content.chapters.length - 1) {
                    this.dom.nextChapterBtn.classList.add('disabled');
                } else {
                    this.dom.nextChapterBtn.classList.remove('disabled');
                }
            }

            initObservers() {
                const chapterObserver = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        const id = entry.target.id;
                        const chapterIndex = this.content.chapters.findIndex(c => c.id === id);
                        entry.target.classList.toggle('active', entry.isIntersecting);

                        if (entry.isIntersecting) {
                            this.currentChapterIndex = chapterIndex;
                            this.updateNavButtonsState();

                            if (!this.isDragging) {
                                this.dom.headerTitle.textContent = this.content.chapters[chapterIndex].title;
                            }
                            document.querySelectorAll(`[data-target-id]`).forEach(node => {
                                const isCurrent = node.dataset.targetId === id;
                                const nodeIndex = this.content.chapters.findIndex(c => c.id === node.dataset.targetId);
                                node.classList.toggle('active', isCurrent);
                                node.classList.toggle('past', nodeIndex < chapterIndex);
                            });
                            
                            const progress = (chapterIndex / (this.content.chapters.length - 1)) * 100;
                            this.dom.timelineProgressMobile.style.width = `${progress}%`;

                            const desktopLine = this.dom.timelineProgressDesktop;
                            if (desktopLine) {
                                const pathLength = parseFloat(desktopLine.style.strokeDasharray) || 0;
                                const progressFraction = chapterIndex / (this.content.chapters.length - 1);
                                desktopLine.style.strokeDashoffset = pathLength * (1 - progressFraction);
                            }
                        }
                    });
                }, { rootMargin: "-40% 0px -50% 0px", threshold: 0 });
                
                document.querySelectorAll('.story-chapter').forEach(chapter => chapterObserver.observe(chapter));

                const headerObserver = new IntersectionObserver(([entry]) => {
                    this.dom.header.classList.toggle('scrolled', !entry.isIntersecting);
                }, { threshold: [1] });
                
                headerObserver.observe(this.dom.scrollSentinel);
            }
        }
        
        class Quiz {
            constructor(questions) {
                this.allQuestions = questions;
                this.dom = {
                    overlay: document.getElementById('quiz-overlay'),
                    container: document.getElementById('quiz-container'),
                };
                this.state = {};
                this.localStorageKey = 'microEconQuizState';
                this.savedScrollPosition = 0; 
            }
            start() {
                if(navigator.vibrate) navigator.vibrate(20);
                const savedState = this.loadState();
                if (savedState) { this.renderResumePrompt(); } 
                else { this.beginNewQuiz(); }
            }
            resume() {
                if(navigator.vibrate) navigator.vibrate(20);
                this.state = this.loadState();
                this.openOverlay();
                this.startQuizUI();
                this.renderQuestion();
            }
            beginNewQuiz() {
                if(navigator.vibrate) navigator.vibrate(20);
                this.state = {
                    questions: this.shuffleArray([...this.allQuestions]),
                    currentQuestionIndex: 0,
                    score: 0,
                    answered: false,
                };
                this.saveState();
                this.openOverlay();
                this.renderIntro();
            }
            openOverlay() {
                this.savedScrollPosition = window.scrollY;
                this.dom.overlay.classList.add('visible');
                document.body.classList.add('no-scroll');
            }
            close() {
                if(navigator.vibrate) navigator.vibrate(20);
                this.dom.overlay.classList.remove('visible');
                document.body.classList.remove('no-scroll');
                window.scrollTo(0, this.savedScrollPosition);
            }
            saveState() { localStorage.setItem(this.localStorageKey, JSON.stringify(this.state)); }
            loadState() { const saved = localStorage.getItem(this.localStorageKey); return saved ? JSON.parse(saved) : null; }
            clearState() { localStorage.removeItem(this.localStorageKey); }
            
            renderMath() {
                if (typeof renderMathInElement !== 'undefined') {
                    renderMathInElement(this.dom.container, {
                        delimiters: [
                            {left: '$$', right: '$$', display: true},
                            {left: '$', right: '$', display: false}
                        ],
                        throwOnError: false,
                        trust: true
                    });
                }
            }
            
            renderResumePrompt() {
                this.openOverlay();
                this.dom.container.innerHTML = `<div class="quiz-header"><span class="quiz-title">Quiz in Sospeso</span><button class="icon-btn quiz-close-btn" id="quiz-close-resume"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button></div><div class="quiz-body"><div class="quiz-results-wrapper"><h2 class="quiz-results-title">Bentornato!</h2><p class="quiz-results-text">Hai un quiz in sospeso. Vuoi continuare?</p><div class="quiz-results-actions"><button class="quiz-next-btn" id="resume-quiz-btn">Riprendi Quiz</button><button class="quiz-next-btn secondary" id="restart-quiz-btn">Inizia da Capo</button></div></div></div>`;
                document.getElementById('resume-quiz-btn').onclick = () => this.resume();
                document.getElementById('restart-quiz-btn').onclick = () => { this.clearState(); this.beginNewQuiz(); };
                document.getElementById('quiz-close-resume').onclick = () => this.close();
            }
            renderIntro() {
                 this.dom.container.innerHTML = `<div class="quiz-header"><span class="quiz-title">Test di Autovalutazione</span><button class="icon-btn quiz-close-btn" id="quiz-close-intro"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button></div><div class="quiz-body"><div class="quiz-results-wrapper"><h2 class="quiz-results-title">Sei pronto?</h2><p class="quiz-results-text">Verifica la tua preparazione con ${this.state.questions.length} domande.</p><button class="quiz-next-btn" id="start-quiz-btn">Inizia il Quiz</button></div></div>`;
                 document.getElementById('start-quiz-btn').onclick = () => { this.startQuizUI(); this.renderQuestion(); };
                 document.getElementById('quiz-close-intro').onclick = () => this.close();
            }
            startQuizUI() {
                if(navigator.vibrate) navigator.vibrate(20);
                this.dom.container.innerHTML = `<div class="quiz-header"><span class="quiz-title" id="quiz-progress-text"></span><button class="icon-btn quiz-close-btn" id="quiz-close-main"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button></div><div class="quiz-body"><div id="quiz-content-wrapper"></div></div><div class="quiz-footer"><button class="quiz-next-btn" id="quiz-next-btn" disabled>Avanti</button></div>`;
                document.getElementById('quiz-next-btn').onclick = () => this.nextQuestion();
                document.getElementById('quiz-close-main').onclick = () => this.close();
            }
            renderQuestion() {
                this.state.answered = false;
                const question = this.state.questions[this.state.currentQuestionIndex];
                const progressText = `Domanda ${this.state.currentQuestionIndex + 1} di ${this.state.questions.length}`;
                document.getElementById('quiz-progress-text').textContent = progressText;
                const answersHtml = this.shuffleArray(question.options).map(option => `<button class="quiz-answer-btn" data-answer="${option}">${option}</button>`).join('');
                const contentWrapper = document.getElementById('quiz-content-wrapper');
                const oldSlide = contentWrapper.querySelector('.quiz-slide');
                if (oldSlide) {
                    oldSlide.style.opacity = 0;
                    setTimeout(() => {
                        oldSlide.innerHTML = `<p class="quiz-question-text">${question.question}</p><div class="quiz-answers">${answersHtml}</div><div class="quiz-explanation"></div>`;
                        oldSlide.style.opacity = 1;
                        this.addAnswerListeners();
                        this.renderMath();
                    }, 200);
                } else {
                    contentWrapper.innerHTML = `<div class="quiz-slide active"><p class="quiz-question-text">${question.question}</p><div class="quiz-answers">${answersHtml}</div><div class="quiz-explanation"></div></div>`;
                    this.addAnswerListeners();
                    this.renderMath();
                }
                document.getElementById('quiz-next-btn').disabled = true;
            }
            addAnswerListeners() {
                document.querySelectorAll('.quiz-answer-btn').forEach(btn => {
                    btn.onclick = (e) => this.handleAnswer(e.currentTarget);
                });
            }
            handleAnswer(selectedButton) {
                if (this.state.answered) return;
                this.state.answered = true;
                if(navigator.vibrate) navigator.vibrate(20);
                const selectedAnswer = selectedButton.dataset.answer;
                const currentQ = this.state.questions[this.state.currentQuestionIndex];
                const correctAnswer = currentQ.correctAnswer;
                
                if (selectedAnswer === correctAnswer) {
                    this.state.score++;
                    selectedButton.classList.add('correct');
                } else {
                    selectedButton.classList.add('incorrect');
                    const correctBtn = Array.from(document.querySelectorAll('.quiz-answer-btn')).find(btn => btn.dataset.answer === correctAnswer);
                    if (correctBtn) correctBtn.classList.add('correct');
                }
                
                document.querySelectorAll('.quiz-answer-btn').forEach(btn => btn.classList.add('disabled'));
                document.getElementById('quiz-next-btn').disabled = false;
                
                const explanationEl = document.querySelector('.quiz-explanation');
                if(explanationEl) {
                    const explText = currentQ.explanation || ("La risposta corretta è: " + correctAnswer);
                    explanationEl.innerHTML = "<strong>Spiegazione:</strong> " + explText;
                    explanationEl.classList.add('visible');
                    this.renderMath();
                }
                
                this.saveState();
            }
            nextQuestion() {
                if(navigator.vibrate) navigator.vibrate(20);
                this.state.currentQuestionIndex++;
                if (this.state.currentQuestionIndex < this.state.questions.length) {
                    this.saveState();
                    this.renderQuestion();
                } else {
                    this.renderResults();
                }
            }
            renderResults() {
                const score = this.state.score;
                const total = this.state.questions.length;
                const percentage = Math.round((score / total) * 100);
                let message = "Puoi fare di meglio.";
                if (percentage >= 70) message = "Ottimo lavoro!";
                if (percentage >= 90) message = "Eccellente!";
                this.clearState();
                this.dom.container.innerHTML = `<div class="quiz-header"><span class="quiz-title">Risultati</span></div><div class="quiz-body"><div class="quiz-results-wrapper"><h2 class="quiz-results-title">${message}</h2><div class="quiz-results-score">${score} / ${total}</div><p class="quiz-results-text">Risposte corrette: ${percentage}%</p><div class="quiz-results-actions"><button class="quiz-next-btn" id="retake-quiz-btn">Riprova il Quiz</button><button class="quiz-next-btn secondary" id="close-results-btn">Torna allo Studio</button></div></div></div>`;
                document.getElementById('retake-quiz-btn').onclick = () => this.beginNewQuiz();
                document.getElementById('close-results-btn').onclick = () => this.close();
            }
            shuffleArray(array) {
                return array.map(value => ({ value, sort: Math.random() })).sort((a, b) => a.sort - b.sort).map(({ value }) => value);
            }
        }
        document.addEventListener('DOMContentLoaded', () => {
            const app = new ScrollytellingApp(learningContent);
            const quiz = new Quiz(quizData);
            document.getElementById('quiz-btn').onclick = () => quiz.start();
        });
    </script>
</body>
</html>
